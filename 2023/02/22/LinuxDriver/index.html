<!DOCTYPE html>


<html lang="en">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="å¥‡ç‚¹åšå®¢â€”â€”åšæ–‡å†…å®¹æ¶µç›–ï¼šè‡ªåŠ¨åŒ–æ§åˆ¶ã€ç¡¬ä»¶è®¾è®¡ã€åµŒå…¥å¼è½¯ä»¶ã€é‡‘èã€ä¸ªäººè®¤çŸ¥" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>é€Ÿé€šLinuxé©±åŠ¨ç¨‹åº |  Singularity-blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/S-favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-LinuxDriver"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  é€Ÿé€šLinuxé©±åŠ¨ç¨‹åº
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/02/22/LinuxDriver/" class="article-date">
  <time datetime="2023-02-22T11:55:32.000Z" itemprop="datePublished">2023-02-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F%E9%A9%B1%E5%8A%A8/">åµŒå…¥å¼é©±åŠ¨</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">8.9k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading timeâ‰ˆ</span>
            <span class="post-count">39 min</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <blockquote>
<p>ç—›è‹¦ï¼Œéå¸¸çš„ç—›è‹¦ï¼å­¦Linuxçš„é©±åŠ¨è¦ä¹ˆä¸Šå¤©è¦ä¹ˆå…¥åœŸï¼Œå› æ­¤ç¬”è€…å†³å®šå†™è¿™ç¯‡åšå®¢å¸®æ‰€æœ‰æƒ³å…¥é—¨Linuxé©±åŠ¨çš„è¯»è€…èµ°åœ°æ›´å®‰è¯¦ã€‚ğŸ˜‡å¦å¤–çš„ï¼Œç¬”è€…åœ¨å­¦ä¹ æ—¶å…·æœ‰ä¸€å®šç¨‹åº¦çš„ç¡¬ä»¶çŸ¥è¯†å‚¨å¤‡å’ŒåµŒå…¥å¼è£¸æœºå¼€å‘ç»éªŒï¼Œå› æ­¤æœ¬æ–‡å°†ä¸ä¼šå¤ªå¤šåœ°å¸®åŠ©ç¡¬ä»¶å°ç™½ï¼Œå»ºè®®é˜…è¯»å­¦ä¹ ç¬”è€…ä¹‹å‰çš„ç¡¬ä»¶ç›¸å…³åšå®¢æˆ–å…¶ä»–å¤§ç¥çš„å…¥é—¨æ•™ç¨‹ã€‚</p>
</blockquote>
<h2 id="Linuxè®¾å¤‡é©±åŠ¨æ¦‚å¿µç¯‡"><a href="#Linuxè®¾å¤‡é©±åŠ¨æ¦‚å¿µç¯‡" class="headerlink" title="Linuxè®¾å¤‡é©±åŠ¨æ¦‚å¿µç¯‡"></a>Linuxè®¾å¤‡é©±åŠ¨æ¦‚å¿µç¯‡</h2><h3 id="é©±åŠ¨ç±»å‹"><a href="#é©±åŠ¨ç±»å‹" class="headerlink" title="é©±åŠ¨ç±»å‹"></a>é©±åŠ¨ç±»å‹</h3><p>Linuxå¤©ä¸‹æ— æ•Œï¼Œæ”¯æŒæ‰€æœ‰çš„ç¡¬ä»¶å¤–è®¾ï¼Œæ‰€ä»¥æå‡ºäº†3ä¸ªç±»åˆ«çš„é©±åŠ¨ç¨‹åºã€‚</p>
<table>
<thead>
<tr>
<th align="center">é©±åŠ¨ç±»å‹</th>
<th align="center">ç‰¹ç‚¹</th>
<th align="center">å¸¸è§è®¾å¤‡</th>
</tr>
</thead>
<tbody><tr>
<td align="center">å­—ç¬¦è®¾å¤‡</td>
<td align="center">æ“ä½œå­—èŠ‚æ•°æ®</td>
<td align="center">GPIOã€I2Cã€SPIã€éŸ³é¢‘ã€æ˜¾å¡</td>
</tr>
<tr>
<td align="center">å—è®¾å¤‡</td>
<td align="center">ä¸€æ¬¡æ“ä½œä¸€ç»„ï¼ˆå—ï¼‰æ•°æ®</td>
<td align="center">EMMCã€NANDã€SD Card</td>
</tr>
<tr>
<td align="center">ç½‘ç»œè®¾å¤‡</td>
<td align="center">å¥—æ¥å­—ï¼ˆsocketï¼‰æ“ä½œ</td>
<td align="center">ä»¥å¤ªç½‘</td>
</tr>
</tbody></table>
<p>å­—ç¬¦è®¾å¤‡å¸¸å¸¸è¢«åˆ›å»ºä¸ºè®¾å¤‡èŠ‚ç‚¹ï¼Œä»¥ç±»ä¼¼æ–‡ä»¶çš„å½¢å¼å­˜åœ¨äº<code>/dev/</code>ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ä¸²å£<code>/dev/tty</code>ï¼‰ï¼Œè¿™ç§å½¢å¼æ“ä½œèµ·æ¥å’Œå¯¹æ™®é€šæ–‡ä»¶çš„æ“ä½œæå…¶ç›¸ä¼¼ï¼ŒåŒæ—¶å­—ç¬¦è®¾å¤‡ç±»é©±åŠ¨æ˜¯æœ€å¸¸è§çš„ï¼Œåšé¡¹ç›®æ—¶å†™çš„æœ€å¤šçš„ï¼Œä½†æ˜¯3ç§é©±åŠ¨é‡Œæœ€ç®€å•çš„ã€‚<br>å¦å¤–ä¸¤ç§é©±åŠ¨ï¼Œå—è®¾å¤‡å’Œç½‘ç»œè®¾å¤‡ï¼Œé©±åŠ¨æ¨¡å‹å†™èµ·æ¥åˆè‡­åˆé•¿ï¼Œä¸€èˆ¬ICå™¨ä»¶çš„å‚å®¶éƒ½æŠŠé©±åŠ¨å†™å¥½äº†ï¼Œå±äºLinuxé«˜æ‰‹çš„ç©ç‰©ã€‚</p>
<p>å› æ­¤ï¼Œæœ¬æ–‡ä¸­å°†ä¸»è¦åˆ†äº«å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„å¼€å‘ã€‚</p>
<h3 id="å†…æ ¸æ€"><a href="#å†…æ ¸æ€" class="headerlink" title="å†…æ ¸æ€"></a>å†…æ ¸æ€</h3><p>Linuxåœ¨éš”ç¦»ä¸šåŠ¡åº”ç”¨å’Œç¡¬ä»¶è¿™å—åšçš„éå¸¸å¥½ï¼Œæ“ä½œç³»ç»Ÿä¸Šåˆ†ä¸ºäº†ï¼š<strong>ç”¨æˆ·æ€</strong>å’Œ<strong>å†…æ ¸æ€</strong>ã€‚å†…æ ¸æ€æä¾›æœåŠ¡ç»™ç”¨æˆ·æ€è°ƒç”¨ï¼Œå…·æœ‰ç»Ÿä¸€çš„æŠ½è±¡æ¥å£ï¼Œä½¿å¾—ç”¨æˆ·æ€ç¨‹åºå¯ä»¥åœ¨ä¸äº†è§£ç¡¬ä»¶çš„æƒ…å†µä¸‹å¾ˆå¥½åœ°è¿è¡Œå¹¶æ“ä½œæ‰€éœ€ç¡¬ä»¶ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬è¦ç¼–å†™çš„é©±åŠ¨ç¨‹åºå°±æ˜¯å·¥ä½œåœ¨å†…æ ¸æ€ï¼Œæ‰€ä»¥ç¼–å†™æ—¶è¦æ»¡è¶³Linuxçš„æ¨¡å‹ã€‚</p>
<p><img src="http://imgjry.fangyikuan.xyz/20230222/20230222-Linux-1.jpeg" alt="ç”¨æˆ·æ€ä¸å†…æ ¸æ€"></p>
<h3 id="é©±åŠ¨ç¨‹åºè¿è¡Œæ–¹å¼"><a href="#é©±åŠ¨ç¨‹åºè¿è¡Œæ–¹å¼" class="headerlink" title="é©±åŠ¨ç¨‹åºè¿è¡Œæ–¹å¼"></a>é©±åŠ¨ç¨‹åºè¿è¡Œæ–¹å¼</h3><span id="more"></span>

<p>Linuxé©±åŠ¨æœ‰ä¸¤ç§è¿è¡Œçš„æ–¹æ³•ï¼š</p>
<ul>
<li><strong>é™æ€è½¬è½½</strong>ï¼šé©±åŠ¨ç¨‹åºæºç å’ŒLinuxå†…æ ¸ä»£ç æ”¾ä¸€èµ·ï¼Œç¼–è¯‘è¿›Linuxå†…æ ¸ï¼Œå¯åŠ¨Linuxæ—¶è‡ªåŠ¨è¿è¡Œé©±åŠ¨ç¨‹åºã€‚</li>
<li>åŠ¨æ€è£…è½½ï¼ˆ<strong>æ¨¡å—æœºåˆ¶</strong>ï¼‰ï¼šé©±åŠ¨ç¨‹åºå•ç‹¬ç¼–è¯‘æˆ<code>.ko</code>æ¨¡å—ï¼ŒLinuxå†…æ ¸æ­£å¸¸è¿è¡Œæ—¶ï¼Œåœ¨éœ€è¦çš„æƒ…å†µä¸‹ä½¿ç”¨<code>insmod</code>æˆ–<code>modprobe</code>ç­‰æ–¹å¼åŠ è½½é©±åŠ¨æ¨¡å—ã€‚</li>
</ul>
<blockquote>
<p>ä½¿ç”¨<code>modprobe</code>éœ€è¦å…ˆåœ¨<code>/lib/modules/å†…æ ¸ç‰ˆæœ¬å·/modules.dep</code>æ–‡ä»¶ä¸­æ³¨å†Œå’Œå£°æ˜æ¨¡å—ä¾èµ–å…³ç³»ï¼›è‹¥æ²¡æœ‰ä¾èµ–å…¶ä»–é©±åŠ¨ï¼Œç›´æ¥ä½¿ç”¨<code>depmod</code>å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>insmod</code>ã€‚å¦å¤–çš„ï¼ŒåŠ¨æ€é©±åŠ¨<code>.ko</code>æ¨¡å—è¦æ”¾ç½®äºè¯¥é©±åŠ¨ç›®å½•ä¸­</p>
</blockquote>
<p>å°†é©±åŠ¨è·‘èµ·æ¥åï¼Œåœ¨<code>/dev</code>ç›®å½•ä¸‹ä¼šå‡ºç°ç›¸åº”çš„è®¾å¤‡ï¼Œè¿™æ˜¯Linuxå°†â€œè®¾å¤‡ä½œä¸ºæ–‡ä»¶â€å¤„ç†çš„æ€æƒ³ã€‚å½“åº”ç”¨ç¨‹åºï¼ˆæˆ–SDKï¼‰è¦æ“ä½œå¯¹åº”çš„ç¡¬ä»¶æ—¶ï¼Œä½¿ç”¨å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨æ¥å£å³å¯ï¼Œå¦‚<code>open</code>ã€<code>write</code>ç­‰ã€‚</p>
<p><img src="http://imgjry.fangyikuan.xyz/20230222/20230222-Linux-2.png" alt="devç›®å½•"></p>
<h2 id="é©±åŠ¨ç¼–å†™TIPs"><a href="#é©±åŠ¨ç¼–å†™TIPs" class="headerlink" title="é©±åŠ¨ç¼–å†™TIPs"></a>é©±åŠ¨ç¼–å†™TIPs</h2><ul>
<li>ä¸èƒ½ä½¿ç”¨æ ‡å‡†Cåº“ï¼å› ä¸ºé©±åŠ¨ç¨‹åºè¿è¡Œåœ¨å†…æ ¸æ€ï¼ŒCåº“æ˜¯åŸºäºç³»ç»Ÿè°ƒç”¨å®ç°åœ¨ç”¨æˆ·æ€ã€‚<blockquote>
<p>å¯ä»¥ä½¿ç”¨å†…æ ¸ç‰ˆæ¥å£ï¼Œæ¯”å¦‚<code>printf</code>æ‰“å°å‡½æ•°åœ¨é©±åŠ¨ç¨‹åºä¸­å¯¹åº”è°ƒç”¨<code>printk</code>å†…æ ¸å®ç°çš„æ‰“å°å‡½æ•°ã€‚</p>
</blockquote>
</li>
<li>å¿…é¡»ç”¨GUN Cç¼–è¯‘ï¼</li>
<li>å†…æ ¸åªæœ‰å¾ˆå°çš„å®šé•¿å †æ ˆï¼32ä½æœºå†…æ ¸æ ˆ8KBï¼Œ64ä½æœº16KBã€‚</li>
<li>å°å¿ƒæŒ‡é’ˆï¼å†…æ ¸ç†è§£ä¸ºè£¸æœºç¨‹åºï¼Œæ²¡å†…å­˜ä¿æŠ¤æœºåˆ¶ï¼Œä¸€æ—¦è®¿é—®éæ³•å†…å­˜å¯èƒ½ç›´æ¥æ­»æœº</li>
<li>é¿å…ç”¨æµ®ç‚¹ï¼</li>
<li>å°å¿ƒå­—èŠ‚åºï¼</li>
</ul>
<h2 id="å°è¯•ç‰›åˆ€â€”â€”å­—ç¬¦è®¾å¤‡é©±åŠ¨"><a href="#å°è¯•ç‰›åˆ€â€”â€”å­—ç¬¦è®¾å¤‡é©±åŠ¨" class="headerlink" title="å°è¯•ç‰›åˆ€â€”â€”å­—ç¬¦è®¾å¤‡é©±åŠ¨"></a>å°è¯•ç‰›åˆ€â€”â€”å­—ç¬¦è®¾å¤‡é©±åŠ¨</h2><blockquote>
<p>ç¯å¢ƒå£°æ˜ï¼š</p>
<ul>
<li>Ubuntu 18.04</li>
<li>GUN Make 4.1</li>
<li>gcc 7.5.0</li>
</ul>
</blockquote>
<h3 id="Demoè·‘ä¸€ä¸‹"><a href="#Demoè·‘ä¸€ä¸‹" class="headerlink" title="Demoè·‘ä¸€ä¸‹"></a>Demoè·‘ä¸€ä¸‹</h3><p>è¿™è¾¹æ¼”ç¤ºçš„æ˜¯æœ€å¸¸è§è€Œç®€å•çš„å­—ç¬¦å‹è®¾å¤‡é©±åŠ¨ï¼Œæ–‡ä»¶åä¸ºchrDriver.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment"> *  ä»¥ä¸‹ä¸ºé©±åŠ¨çº§çš„å®ç°æ¥å£</span></span><br><span class="line"><span class="comment"> * è£…è½½è¿› file_operations ç»“æ„ä½“</span></span><br><span class="line"><span class="comment">**********************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">mydev_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *data, <span class="type">size_t</span> size, <span class="type">loff_t</span> * loff)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;mydev_read\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">mydev_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *data, <span class="type">size_t</span> size, <span class="type">loff_t</span> *loff)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;mydev_write\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mydev_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;mydev_open\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment"> *  ä»¥ä¸‹ä¸ºç³»ç»Ÿçº§çš„æ¥å£é€‚é…</span></span><br><span class="line"><span class="comment"> * å®ç°é©±åŠ¨æ¨¡å—çš„æ³¨å†Œå’Œæ³¨é”€</span></span><br><span class="line"><span class="comment">**********************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">dev_t</span> dev_id;    <span class="comment">// è®¾å¤‡å·</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> *<span class="title">mydev</span>;</span>  <span class="comment">// è®¾å¤‡ä¿¡æ¯æ±‡æ€»</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">mydev_class</span>;</span> <span class="comment">// è®¾å¤‡æ–‡ä»¶åŒ–ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ–‡ä»¶æ“ä½œé›†åˆ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">mydev_fops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">    .read   = mydev_read,</span><br><span class="line">    .open   = mydev_open,</span><br><span class="line">    .write  = mydev_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __init <span class="type">int</span> <span class="title function_">mydev_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* ç”³è¯·è®¾å¤‡å· */</span></span><br><span class="line">    alloc_chrdev_region(&amp;dev_id, <span class="number">1</span>, <span class="number">1</span>, <span class="string">&quot;mydev&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆ†é…å­—ç¬¦è®¾å¤‡ */</span></span><br><span class="line">    mydev = cdev_alloc();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¾ç½®å­—ç¬¦è®¾å¤‡ */</span></span><br><span class="line">    cdev_init(mydev, &amp;mydev_fops);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ³¨å†Œå­—ç¬¦è®¾å¤‡ */</span></span><br><span class="line">    cdev_add(mydev, dev_id, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ‰“å°ç”³è¯·åˆ°çš„ä¸»æ¬¡è®¾å¤‡å· */</span></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;major:%d; minor:%d\n&quot;</span>, MAJOR(dev_id), MINOR(dev_id));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¾å¤‡ æ–‡ä»¶åŒ–*/</span></span><br><span class="line">    mydev_class = class_create(THIS_MODULE, <span class="string">&quot;chrDevFile&quot;</span>);</span><br><span class="line">    <span class="comment">/* åˆ›å»º/dev/mydev*/</span></span><br><span class="line">	device_create(mydev_class, <span class="literal">NULL</span>, dev_id, <span class="literal">NULL</span>, <span class="string">&quot;chrDevFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __exit <span class="type">void</span> <span class="title function_">mydev_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* æ³¨é”€ æ–‡ä»¶åŒ–çš„ /dev/mydev */</span></span><br><span class="line">    device_destroy(mydev_class, dev_id);</span><br><span class="line">    class_destroy(mydev_class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å½’è¿˜ç³»ç»Ÿèµ„æº*/</span></span><br><span class="line">    cdev_del(mydev);</span><br><span class="line">    kfree(mydev);</span><br><span class="line">    unregister_chrdev_region(dev_id, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(mydev_init);        <span class="comment">// ç”Ÿæˆæ¨¡å—æ—¶ï¼ŒæŒ‡æ˜å“ªä¸ªæ¥å£ç”¨äº æ³¨å†Œé©±åŠ¨</span></span><br><span class="line">module_exit(mydev_exit);    <span class="comment">// ç”Ÿæˆæ¨¡å—æ—¶ï¼ŒæŒ‡æ˜å“ªä¸ªæ¥å£ç”¨äº æ³¨é”€é©±åŠ¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment"> *  Linux ä½“ç³»ä¸‹çš„å°ä¹ä¹</span></span><br><span class="line"><span class="comment">**********************************/</span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Makefileçš„ç¼–å†™</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å†…æ ¸æºç </span></span><br><span class="line">KERNELDIR := /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build</span><br><span class="line"><span class="comment"># å½“å‰ç›®å½•</span></span><br><span class="line">CURRENT_PATH := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å–æ¶ˆç­¾åè®¤è¯</span></span><br><span class="line">CONFIG_MODULE_SIG=n</span><br><span class="line"></span><br><span class="line">obj-m := chrDriver.o</span><br><span class="line"> </span><br><span class="line"><span class="section">build: kernel_modules</span></span><br><span class="line"> </span><br><span class="line"><span class="section">kernel_modules:</span></span><br><span class="line">	<span class="comment"># ä¸‹é¢ç¬¬2é¡¹ï¼ŒM=$(CURRENT_PATH) å‘ŠçŸ¥æºç ç¼–è¯‘æ—¶ï¼Œé©±åŠ¨ç¨‹åºåœ¨è¿™</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDIR)</span> M=<span class="variable">$(CURRENT_PATH)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDIR)</span> M=<span class="variable">$(CURRENT_PATH)</span> clean</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆæŠŠè¿™ä¸ªç¨‹åºè·‘èµ·æ¥ï¼Œæœ‰ä¸ªç›´è§‚æ„Ÿå—å†åˆ†æä»£ç å†…å®¹ã€‚é¦–å…ˆæ˜¯ç¼–è¯‘è¿™ä¸ªé©±åŠ¨ç¨‹åºï¼Œå½“ç„¶ ä¸Šé¢çš„<code>.c</code>æºæ–‡ä»¶å’ŒMakefileæ–‡ä»¶è¦æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œè·‘å‘½ä»¤ä¹Ÿåœ¨åŒä¸€ç›®å½•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p>æ¥ç€åŠ è½½é©±åŠ¨ï¼Œå¹¶è§‚å¯Ÿé©±åŠ¨çš„åŠ è½½æƒ…å†µï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo insmod chrDriver.ko</span><br><span class="line">$ lsmod | grep chrDriver</span><br></pre></td></tr></table></figure>

<p>åŠ è½½åï¼Œå¯ä»¥æŸ¥çœ‹é©±åŠ¨è¿è¡Œæ—¶çš„ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg</span><br><span class="line"></span><br><span class="line">[ 7937.803754] major:240; minor:1</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>dmesg</code>å‘½ä»¤ä¼šæ‰“å°å¼€æœºä»¥æ¥æ‰€æœ‰çš„é©±åŠ¨åŠ¨ä½œä¿¡æ¯ï¼Œä¸Šé¢å±•ç¤ºäº†å’Œæˆ‘ä»¬é©±åŠ¨æœ‰å…³çš„ä¸€æ¡ã€‚æ‰§è¡Œ<code>insmod</code>å‘½ä»¤æœ¬è´¨ä¸Šæ‰§è¡Œæºæ–‡ä»¶ä¸­çš„<code>mydev_init</code>æ¥å£ï¼Œåœ¨è¯¥æ¥å£ä¸­æˆ‘ä»¬è°ƒç”¨<code>printk</code>æ‰“å°äº†ä¸¤ä¸ªå·ç ï¼Œæ‰€ä»¥è¿™è¾¹æˆ‘ä»¬èƒ½å¤Ÿå°±çœ‹åˆ°ï¼šåœ¨<code>[ 7937.803754]</code>è¿™ä¸ªæ—¶åˆ»ç³»ç»Ÿè®°å½•äº†<code>major:240; minor:1</code>ä¿¡æ¯ã€‚</p>
<p>è¿™ä¸ªå°å°çš„é©±åŠ¨ç¨‹åºè¿˜å®ç°äº†â€œè®¾å¤‡æ–‡ä»¶åŒ–â€ï¼Œåœ¨<code>/dev/</code>ç›®å½•ä¸‹ï¼Œæ˜¯å¯ä»¥æ‰¾åˆ°<code>chrDevFile</code>è¿™ä¸ªâ€œæ–‡ä»¶â€å“’ï¼Œæ‰§è¡Œï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> /dev</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæµ‹è¯•å®Œæˆæˆ–ä¸éœ€è¦æ—¶ï¼Œå¯ä»¥å¸è½½é©±åŠ¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rmmod chrDriver</span><br></pre></td></tr></table></figure>

<h3 id="å…·ä½“åŸç†"><a href="#å…·ä½“åŸç†" class="headerlink" title="å…·ä½“åŸç†"></a>å…·ä½“åŸç†</h3><p>ä¸Šé¢çš„<code>.c</code>æºæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ç”¨åˆ°äº†3ä¸ªLinuxç³»ç»Ÿå†…æ ¸çš„ç»“æ„&#x2F;ç±»å‹ï¼š<code>dev_t</code>ã€<code>struct cdev</code>å’Œ<code>struct file_operations</code>ã€‚å…·ä½“æ¥çœ‹ä»–ä»¬çš„å†…å®¹ä¸åŠŸèƒ½ï¼š</p>
<ul>
<li>dev_tï¼š<ul>
<li>å­˜æ”¾è®¾å¤‡å·ï¼Œé«˜12ä½ä¸ºä¸»è®¾å¤‡å·ï¼Œä½20ä½ä¸ºæ¬¡è®¾å¤‡å·ï¼Œå…±ä¸º32ä½</li>
<li>è°ƒç”¨å®å¯è·å–ä¸»<code>MAJOR(dev_id)</code>ã€æ¬¡è®¾å¤‡å·<code>MINOR(dev_id)</code>ï¼Œè¿™å°±æ˜¯ä¸Šé¢<code>mydev_init</code>æ¥å£é‡Œ<code>printk</code>æ‰“å°çš„ä¸œè¥¿ã€‚</li>
</ul>
</li>
<li>cdevï¼š<ul>
<li>æŠŠ é©±åŠ¨æ¨¡å—ã€å­—ç¬¦è®¾å¤‡æ“ä½œæ¥å£é›†ã€è®¾å¤‡å· å…³è”èµ·æ¥</li>
<li>æ‰€æœ‰ä¸œè¥¿å‡†å¤‡å¥½åï¼Œè¿™ä¸ªå®¶ä¼™è´Ÿè´£æ±‡æ€»äº†ç»Ÿä¸€æŠ¥å‘Šç»™å†…æ ¸</li>
<li>ä½äº<code>cdev.h</code>æ–‡ä»¶ä¸­çš„å®šä¹‰ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>    <span class="comment">// å†…æ ¸å¯¹è±¡ï¼Œæ‰€æœ‰å†…æ ¸æ“ä½œéƒ½è¦æœ‰è¿™ä¸ªï¼Œç±»ä¼¼C++çš„ç»§æ‰¿</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>   <span class="comment">// æ‰€å±æ¨¡å—</span></span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">ops</span>;</span>  <span class="comment">// æ–‡ä»¶æ“ä½œé›†</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">  <span class="type">dev_t</span> dev;          <span class="comment">// è®¾å¤‡å·</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>file_operations<ul>
<li>ä½äº<code>fs.h</code>æ–‡ä»¶ä¸­çš„å®šä¹‰ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span> <span class="comment">// æ‰€å±æ¨¡å—</span></span><br><span class="line">  <span class="type">loff_t</span> (*llseek) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* åŸºç¡€æ–‡ä»¶æ“ä½œï¼šè¯»ã€å†™*/</span></span><br><span class="line">  <span class="type">ssize_t</span> (*read) (<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">  <span class="type">ssize_t</span> (*write) (<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">  <span class="type">ssize_t</span> (*read_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">  <span class="type">ssize_t</span> (*write_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">  </span><br><span class="line">  <span class="type">int</span> (*iopoll)(<span class="keyword">struct</span> kiocb *kiocb, <span class="type">bool</span> spin);</span><br><span class="line">  <span class="type">int</span> (*iterate) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line">  <span class="type">int</span> (*iterate_shared) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line">  <span class="type">__poll_t</span> (*poll) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> poll_table_struct *);</span><br><span class="line">  <span class="type">long</span> (*unlocked_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">  <span class="type">long</span> (*compat_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">  <span class="type">int</span> (*mmap) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> mmap_supported_flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*åŸºç¡€æ‰“å¼€ã€å…³é—­ç­‰*/</span></span><br><span class="line">  <span class="type">int</span> (*open) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">  <span class="type">int</span> (*flush) (<span class="keyword">struct</span> file *, <span class="type">fl_owner_t</span> id);</span><br><span class="line">  <span class="type">int</span> (*release) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> (*fsync) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span> datasync);</span><br><span class="line">  <span class="type">int</span> (*fasync) (<span class="type">int</span>, <span class="keyword">struct</span> file *, <span class="type">int</span>);</span><br><span class="line">  <span class="type">int</span> (*lock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">  <span class="type">ssize_t</span> (*sendpage) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> page *, <span class="type">int</span>, <span class="type">size_t</span>, <span class="type">loff_t</span> *, <span class="type">int</span>);</span><br><span class="line">  <span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line">  <span class="type">int</span> (*check_flags)(<span class="type">int</span>);</span><br><span class="line">  <span class="type">int</span> (*setfl)(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">  <span class="type">int</span> (*flock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">  <span class="type">ssize_t</span> (*splice_write)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">  <span class="type">ssize_t</span> (*splice_read)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="keyword">struct</span> pipe_inode_info *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">  <span class="type">int</span> (*setlease)(<span class="keyword">struct</span> file *, <span class="type">long</span>, <span class="keyword">struct</span> file_lock **, <span class="type">void</span> **);</span><br><span class="line">  <span class="type">long</span> (*fallocate)(<span class="keyword">struct</span> file *file, <span class="type">int</span> mode, <span class="type">loff_t</span> offset,</span><br><span class="line">        <span class="type">loff_t</span> len);</span><br><span class="line">  <span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> file *f);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line">  <span class="type">unsigned</span> (*mmap_capabilities)(<span class="keyword">struct</span> file *);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="type">ssize_t</span> (*copy_file_range)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="keyword">struct</span> file *,</span><br><span class="line">      <span class="type">loff_t</span>, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">  <span class="type">loff_t</span> (*remap_file_range)(<span class="keyword">struct</span> file *file_in, <span class="type">loff_t</span> pos_in,</span><br><span class="line">          <span class="keyword">struct</span> file *file_out, <span class="type">loff_t</span> pos_out,</span><br><span class="line">          <span class="type">loff_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> remap_flags);</span><br><span class="line">  <span class="type">int</span> (*fadvise)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">  <span class="type">bool</span> may_pollfree;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure></li>
<li>è¿™ä¸ªç»“æ„ä½“é‡Œï¼Œæˆ‘ä»¬æœ€åŸºç¡€çš„å°±æ˜¯æŠŠå®ç°çš„<code>read</code>ã€<code>write</code>ã€<code>open</code>ã€<code>release</code>å‡½æ•°æŒ‡é’ˆé™„ä¸Šã€‚</li>
</ul>
</li>
</ul>
<p>äº†ç»“äº†è¿™3ä¸ªå…³é”®æ•°æ®ç±»å‹åï¼Œå†å»çœ‹æºç å°±å¾ˆç®€å•äº†ã€‚æˆ‘ä»¬é‡‡å–è‡ªé¡¶å‘ä¸‹çš„æ–¹å¼ï¼Œå¥½ç†è§£ä¸€ä¸ªé©±åŠ¨æ¨¡å—çš„å·¥ä½œåŸç†å’Œç¼–å†™æ¨¡å‹ï¼š</p>
<ul>
<li>æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼Œ<code>insmod</code>åŠ è½½<code>.ko</code>é©±åŠ¨æ¨¡å—æœ¬è´¨ä¸Šè°ƒç”¨äº†<code>mydev_init</code>ï¼Œå‘å†…æ ¸ç”³è¯·èµ„æºå’Œæ³¨å†Œé©±åŠ¨ç¨‹åºçš„ä¿¡æ¯ã€‚ä¾æ¬¡ä¸ºï¼š<ol>
<li>ç”³è¯·è®¾å¤‡å·<code>alloc_chrdev_region</code></li>
<li>åˆ†é…å­—ç¬¦è®¾å¤‡<code>cdev_alloc</code></li>
<li>è®¾ç½®å­—ç¬¦è®¾å¤‡<code>cdev_init</code>ï¼Œå…³è”<code>cdev</code>å’Œ<code>file_operations</code>ä¸¤ä¸ªç»“æ„ä½“</li>
<li>æ³¨å†Œå­—ç¬¦è®¾å¤‡<code>cdev_add</code></li>
<li>è®¾å¤‡æ–‡ä»¶åŒ–<code>device_create</code></li>
</ol>
</li>
<li>å½“é©±åŠ¨ç¨‹åºä¸ç”¨æ—¶ï¼Œ<code>rmmod</code>æœ¬è´¨ä¸Šè°ƒç”¨äº†<code>mydev_exit</code>ï¼Œä¾æ¬¡ï¼š<ol>
<li>åœ¨å†…æ ¸ä¸­åˆ é™¤å­—ç¬¦è®¾å¤‡<code>cdev_del</code>;</li>
<li>é‡Šæ”¾ç”³è¯·çš„å­—ç¬¦è®¾å¤‡èµ„æº<code>kfree</code>;</li>
<li>å½’è¿˜ç”³è¯·çš„è®¾å¤‡å·èµ„æº<code>unregister_chrdev_region</code>;</li>
<li>æ³¨é”€æ–‡ä»¶åŒ–å¯¹è±¡<code>device_destroy</code></li>
</ol>
</li>
</ul>
<blockquote>
<p>æ–‡ä»¶åŒ–é©±åŠ¨å¯¹è±¡ï¼Œçš„ä¸“ä¸šæœ¯è¯­åº”è¯¥æ˜¯<strong>åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</strong>ï¼Œè¿™è¾¹ç¬”è€…æ˜¯ä¸ºäº†å¥½ç†è§£è¿™ä¹ˆå«çš„ã€‚</p>
</blockquote>
<h3 id="åœ¨åº”ç”¨å±‚ä½¿ç”¨è¿™ä¸ªå­—ç¬¦é©±åŠ¨"><a href="#åœ¨åº”ç”¨å±‚ä½¿ç”¨è¿™ä¸ªå­—ç¬¦é©±åŠ¨" class="headerlink" title="åœ¨åº”ç”¨å±‚ä½¿ç”¨è¿™ä¸ªå­—ç¬¦é©±åŠ¨"></a>åœ¨åº”ç”¨å±‚ä½¿ç”¨è¿™ä¸ªå­—ç¬¦é©±åŠ¨</h3><p>ä¸Šé¢å·²ç»è¯´æ˜äº†ï¼ŒåŠ è½½é©±åŠ¨æ¨¡å—ååœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°<code>/dev/chrDevFile</code>ï¼Œæ‰€ä»¥å¯ä»¥æŠŠè¿™ä¸ªè®¾å¤‡å½“ä½œæ–‡ä»¶ä¸€æ ·å»å¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> val = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/dev/chrDevFile&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    write(fd, &amp;val, <span class="keyword">sizeof</span>(val));</span><br><span class="line"></span><br><span class="line">    read(fd, &amp;val, <span class="keyword">sizeof</span>(val));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘åè¿è¡Œï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gcc test_chrDriver.c -o test_chrDriver</span><br><span class="line">$ sudo <span class="built_in">chmod</span> 777 /dev/chrDevFile</span><br><span class="line">$ ./test_chrDriver</span><br></pre></td></tr></table></figure>

<p>å†æ¬¡ä½¿ç”¨<code>dmesg</code>æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg</span><br><span class="line"></span><br><span class="line">[13192.810102] major:240; minor:1</span><br><span class="line">[13306.403353] mydev_open</span><br><span class="line">[13306.403354] mydev_write</span><br><span class="line">[13306.403354] mydev_read</span><br></pre></td></tr></table></figure>

<p>è¿™äº›é©±åŠ¨æ‰“å°çš„ä¿¡æ¯è¯´æ˜ï¼šç”¨æˆ·å±‚è°ƒç”¨çš„æ ‡å‡†æ–‡ä»¶æ“ä½œæ¥å£ï¼ŒLinuxä¸€ä¸€å¯¹æ¥åˆ°äº†é©±åŠ¨å±‚æˆ‘ä»¬å®ç°çš„é©±åŠ¨æ¥å£ã€‚</p>
<h2 id="è¿›é˜¶å‰å¿…å¤‡åˆ©å™¨"><a href="#è¿›é˜¶å‰å¿…å¤‡åˆ©å™¨" class="headerlink" title="è¿›é˜¶å‰å¿…å¤‡åˆ©å™¨"></a>è¿›é˜¶å‰å¿…å¤‡åˆ©å™¨</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/">Linux Kernel Document</a>ï¼šå†…æ ¸APIåœ¨çº¿é€ŸæŸ¥ã€‚</p>
<blockquote>
<p>ç¬”è€…åœ¨æ¥ä¸‹æ¥çš„è¿›é˜¶éƒ¨åˆ†ï¼Œå°†ä¸å¯¹æ¯ä¸ªç»“æ„ä½“å’Œæ¥å£åšå…·ä½“è¯´æ˜ã€‚å› ä¸ºå®˜æ–¹çš„è¯´æ˜æ˜¯æœ€å‡†ç¡®çš„ï¼Œè€Œæœ¬æ–‡å°†ä¾§é‡äºå¼€å‘æ€æƒ³çš„å­¦ä¹ ï¼Œå»ºè®®è¯»è€…è¾¹æŸ¥è¾¹å­¦ã€‚</p>
</blockquote>
</li>
<li><p>Source Insightï¼šé˜…è¯»Linuxå†…æ ¸ä»£ç å¿…å¤‡ç¥å™¨</p>
<p>  å› ä¸ºè¿™ä¸ªSourceInsightæ˜¯Windowsè½¯ä»¶ï¼Œæ‰€ä»¥æƒ³åœ¨Linuxä¸Šè·‘åœ°å…ˆä¸‹ä¸€ä¸ªç±»ä¼¼è™šæ‹Ÿæœºä½†ä¸æ˜¯è™šæ‹Ÿæœºçš„ä¸œè¥¿â€”â€”Wine</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install wine-development -y</span><br><span class="line">$ sudo apt install wine64 -y</span><br><span class="line">$ wine --version</span><br></pre></td></tr></table></figure>
<p>  ç„¶åå°±å¯ä»¥æ­£å¼ä¸‹è½½å®‰è£…äº†</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://s3-us-west-2.amazonaws.com/assets.sourceinsight.com/download/v4/release/sourceinsight40126-setup.exe</span><br><span class="line"></span><br><span class="line">$ wine sourceinsight40126-setup.exe</span><br></pre></td></tr></table></figure>
<p>  å®‰è£…çš„æ—¶å€™ï¼Œè¿™ä¸ªè½¯ä»¶è¦å¯¼å…¥Licenseï¼Œç½‘ç»œä¸Šå¾ˆå¤šï¼Œç¬”è€…æ”¯æŒæ­£ç‰ˆä¸æä¾›ã€‚å¦‚æœé‡‡ç”¨çš„é»˜è®¤è·¯å¾„(<code>C://Program Files (x86)</code>)å®‰è£…ï¼Œé‚£ä¹ˆè¿è¡Œä»¥ä¸‹ä»£ç å¯åŠ¨Source Insightï¼š</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wine ~/.wine/drive_c/Program\ Files\ \(x86\)/Source\ Insight\ 4.0/sourceinsight4.exe</span><br></pre></td></tr></table></figure>
<p>  å¯ä»¥åœ¨æ¡Œé¢å»ºç«‹ä¸€ä¸ªè¿™æ ·çš„shè„šæœ¬ï¼Œåé¢ä¸€é”®è¿è¡Œæ›´æ–¹ä¾¿ã€‚</p>
</li>
</ul>
<h2 id="Linuxé©±åŠ¨ä¸­çš„é«˜çº§æ­¦å™¨"><a href="#Linuxé©±åŠ¨ä¸­çš„é«˜çº§æ­¦å™¨" class="headerlink" title="Linuxé©±åŠ¨ä¸­çš„é«˜çº§æ­¦å™¨"></a>Linuxé©±åŠ¨ä¸­çš„é«˜çº§æ­¦å™¨</h2><h3 id="çº¿ç¨‹é—´åŒæ­¥"><a href="#çº¿ç¨‹é—´åŒæ­¥" class="headerlink" title="çº¿ç¨‹é—´åŒæ­¥"></a>çº¿ç¨‹é—´åŒæ­¥</h3><h4 id="äº’æ–¥é‡Mutex"><a href="#äº’æ–¥é‡Mutex" class="headerlink" title="äº’æ–¥é‡Mutex"></a>äº’æ–¥é‡Mutex</h4><p><img src="http://imgjry.fangyikuan.xyz/20230222/20230222-Linux-3.jpeg" alt="Mutex"></p>
<ul>
<li>ä½œç”¨ï¼šåŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰è¯¥é”</li>
<li>å…·ä½“å®ç°æ–¹å¼ä¸ºï¼š<ol>
<li>ç”³è¯·å æœ‰èµ„æºï¼šæ¯ä¸ªçº¿ç¨‹åœ¨å¯¹å…±äº«èµ„æºæ“ä½œå‰éƒ½å°è¯•å…ˆåŠ é”</li>
<li>ä½¿ç”¨èµ„æºï¼šæˆåŠŸåŠ é”åæ‰å¯ä»¥å¯¹å…±äº«èµ„æºè¿›è¡Œè¯»å†™æ“ä½œï¼Œ</li>
<li>é‡Šæ”¾èµ„æºï¼šæ“ä½œç»“æŸåè§£é”</li>
</ol>
</li>
<li>ä¸»è¦åº”ç”¨å‡½æ•°ï¼š<ul>
<li>åˆå§‹åŒ–<em>åŠ¨æ€</em>äº’æ–¥é‡å¯¹è±¡<code>pthread_mutex_init</code></li>
<li>åˆå§‹åŒ–<em>é™æ€</em>äº’æ–¥é‡å¯¹è±¡<code>PTHREAD_MUTEX_INITIALIZER</code>ã€‚æ³¨æ„è¿™æ˜¯ä¸€ä¸ªå®</li>
<li>æ‘§æ¯äº’æ–¥é‡å¯¹è±¡<code>pthread_mutex_destroy</code></li>
<li>å¿…ä¸Šé”<code>pthread_mutex_lock</code>ã€‚æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªé˜»å¡æ¥å£ï¼Œå¦‚æœåŠ é”ä¸æˆåŠŸï¼Œä¼šç­‰å¾…ç›´åˆ°ä¿¡å·é‡å¯ç”¨</li>
<li>å°è¯•é”<code>pthread_mutex_trylock</code>ã€‚æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªéé˜»å¡æ¥å£ï¼Œå¦‚æœè°ƒç”¨æ—¶ï¼ŒåŠ é”ä¸æˆåŠŸï¼Œä¼šç›´æ¥é€€å‡ºå¹¶è¿”å›å¯¹åº”çš„å€¼</li>
<li>è§£é”&#x2F;é‡Šæ”¾ä¿¡å·é‡<code>pthread_mutex_unlock</code></li>
</ul>
</li>
</ul>
<h4 id="ä¿¡å·é‡Semaphore"><a href="#ä¿¡å·é‡Semaphore" class="headerlink" title="ä¿¡å·é‡Semaphore"></a>ä¿¡å·é‡Semaphore</h4><p><img src="http://imgjry.fangyikuan.xyz/20230222/20230222-Linux-4.png" alt="Semaphore"></p>
<ul>
<li>æœ¬è´¨ï¼šè®¡æ•°å™¨</li>
<li>ç‰¹è´¨ï¼š<ul>
<li>é€‚ç”¨äºå ç”¨èµ„æºè¾ƒä¹…çš„æƒ…å†µã€‚å› ä¸ºç­‰å¾…èµ„æºçº¿ç¨‹ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€</li>
<li>ä¸­æ–­é‡Œä¸èƒ½ç”¨ã€‚å› ä¸ºä¿¡å·é‡ä¼šå¼•èµ·ä¼‘çœ ï¼Œä¸­æ–­ä¸èƒ½ä¼‘çœ </li>
<li>å æœ‰æ—¶é—´çŸ­çš„ï¼Œä¸é€‚åˆä½¿ç”¨ä¿¡å·é‡ã€‚å› ä¸ºé¢‘ç¹çš„ä¼‘çœ ã€åˆ‡æ¢çº¿ç¨‹å¼•èµ·çš„å¼€é”€è¦è¿œå¤§äºä¿¡å·é‡å¸¦æ¥çš„ä¼˜åŠ¿</li>
</ul>
</li>
<li>ä¸»è¦åº”ç”¨å‡½æ•°ï¼š<ul>
<li>åˆå§‹åŒ–<em>åŠ¨æ€</em>ä¿¡å·é‡å¯¹è±¡<code>sema_init </code></li>
<li>åˆå§‹åŒ–<em>é™æ€</em>ä¿¡å·é‡å¯¹è±¡<code>__SEMAPHORE_INITIALIZER</code>ã€‚æ³¨æ„è¿™æ˜¯ä¸€ä¸ªå®</li>
<li>é˜»å¡å¼è·å–ä¿¡å·é‡<code>down</code></li>
<li>ä¸­æ–­å¼ç­‰å¾…ä¿¡å·é‡<code>down_interruptible</code></li>
<li>å°è¯•è·å–ä¿¡å·é‡<code>down_trylock</code></li>
<li>é‡Šæ”¾&#x2F;æå‡ä¿¡å·é‡<code>up</code></li>
</ul>
</li>
</ul>
<h4 id="ä¸´ç•Œèµ„æºã€ä¸´ç•ŒåŒºã€äº‹ä»¶"><a href="#ä¸´ç•Œèµ„æºã€ä¸´ç•ŒåŒºã€äº‹ä»¶" class="headerlink" title="ä¸´ç•Œèµ„æºã€ä¸´ç•ŒåŒºã€äº‹ä»¶"></a>ä¸´ç•Œèµ„æºã€ä¸´ç•ŒåŒºã€äº‹ä»¶</h4><p><strong>ä¸´ç•Œèµ„æº</strong>ï¼šå¤šçº¿ç¨‹ä¹‹é—´éœ€è¦<em>äº’æ–¥</em>è®¿é—®çš„å…¨å±€å˜é‡&#x2F;å…±äº«å­—æ®µ</p>
<p><strong>ä¸´ç•ŒåŒº</strong>ï¼šåŠ é”åŒºé—´çš„ä»£ç ï¼</p>
<p><strong>äº‹ä»¶</strong>ï¼šç±»ä¼¼äºç¡¬ä»¶é‡Œè¯´çš„ä¸­æ–­ï¼Œä½†æ˜¯Linuxé‡Œç”¨ä¿¡å·é‡è¿™äº›è½¯ä¸­æ–­å®ç°çš„</p>
<ul>
<li>ä¸´ç•ŒåŒºåœ¨ä»»æ„æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¿›è¡Œè®¿é—®</li>
<li>å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¯•å›¾åŒæ—¶è®¿é—®ä¸´ç•ŒåŒºï¼Œé‚£ä¹ˆæœ‰çº¿ç¨‹è¿›å…¥åï¼Œå…¶ä»–çº¿ç¨‹è¯•å›¾è®¿é—®æ—¶å°†è¢«æŒ‚èµ·ï¼Œç›´åˆ°è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ç¦»å¼€ã€‚</li>
</ul>
<h3 id="è¿›ç¨‹é—´é€šä¿¡"><a href="#è¿›ç¨‹é—´é€šä¿¡" class="headerlink" title="è¿›ç¨‹é—´é€šä¿¡"></a>è¿›ç¨‹é—´é€šä¿¡</h3><h4 id="ç®¡é“pipe"><a href="#ç®¡é“pipe" class="headerlink" title="ç®¡é“pipe"></a>ç®¡é“pipe</h4><p><img src="http://imgjry.fangyikuan.xyz/20230222/20230222-Linux-5.png" alt="pipe"></p>
<p>åœ¨å­¦ä¹ Linuxçš„è¿‡ç¨‹ä¸­ï¼ŒåŒ…æ‹¬ä¸Šé¢æˆ‘ä»¬æŸ¥é©±åŠ¨è¡¨çš„æ—¶å€™ï¼Œéƒ½ç”¨åˆ°äº†<code>|</code>è¿™ä¸ªç¬¦å·ï¼Œä¹Ÿå°±æ˜¯ç®¡é“ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lsmod | grep chrDriver</span><br></pre></td></tr></table></figure>

<p>åœ¨ä½¿ç”¨çš„è§’åº¦æ¥çœ‹ï¼Œç®¡é“è¿™ä¸€å·¥å…·ä½¿å¾—æˆ‘ä»¬èƒ½å¤ŸæŠŠ<strong>ä¸€ä¸ªç¨‹åºçš„ç»“æœ è½¬ç»™ å¦ä¸€ä¸ªç¨‹åºä½œä¸ºè¾“å…¥</strong>ã€‚æ¯”å¦‚ä¸Šé¢æ‰§è¡Œçš„è¿™è¡Œå‘½ä»¤ï¼ŒæŠŠ<code>lsmod</code>æŸ¥åˆ°çš„é©±åŠ¨ç»“æœåˆ—è¡¨ é€šè¿‡<code>|</code>ç®¡é“è¾“é€ç»™ <code>grep</code>æŸ¥æ‰¾â€˜chrDriverâ€™å­—ç¬¦ã€‚</p>
<p>ç®¡é“åŸºäºæ–‡ä»¶æè¿°ç¬¦çš„é€šä¿¡æ–¹å¼ï¼Œå½“ä¸€ä¸ªç®¡é“å»ºç«‹æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦fd[0]å’Œfd[1],å…¶ä¸­fd[0]å›ºå®šç”¨äºè¯»ç®¡é“ï¼Œè€Œfd[1]åˆ™å›ºå®šç”¨äºå†™ç®¡é“ï¼Œè¿™æ ·å°±æ„æˆäº†ä¸€ä¸ªåŠåŒå·¥çš„é€šé“ã€‚</p>
<ul>
<li>ä¸»è¦æ¥å£å‡½æ•°<ul>
<li>åˆ›å»ºç®¡é“<code>pipe</code></li>
<li>å…³é—­ç®¡é“<code>close</code></li>
</ul>
</li>
</ul>
<h4 id="ä¿¡å·ï¼ˆsignalï¼‰"><a href="#ä¿¡å·ï¼ˆsignalï¼‰" class="headerlink" title="ä¿¡å·ï¼ˆsignalï¼‰"></a>ä¿¡å·ï¼ˆsignalï¼‰</h4><p><img src="http://imgjry.fangyikuan.xyz/20230222/20230222-Linux-6.png" alt="signal"></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/w903414/article/details/109802539">CSDNä¸€ç¯‡å¾ˆç»†è‡´çš„ä¿¡å·</a></p>
<h4 id="å…±äº«å†…å­˜ï¼ˆshared-memoryï¼‰"><a href="#å…±äº«å†…å­˜ï¼ˆshared-memoryï¼‰" class="headerlink" title="å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰"></a>å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰</h4><p><img src="http://imgjry.fangyikuan.xyz/20230222/20230222-Linux-7.png" alt="shared memory"></p>
<p>Linuxæ“ä½œç³»ç»Ÿç»™æ¯ä¸ªè¿›ç¨‹éƒ½å•ç‹¬å¼€äº†ä¸åŒçš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œä½†æœ‰æ—¶éœ€è¦è¿›ç¨‹é—´ä¸€èµ·å…±äº«å¤§é‡æ•°æ®ï¼Œè¿™å°±å‡ºäº†<strong>å…±äº«å†…å­˜</strong>åŠŸèƒ½ï¼Œæœ¬è´¨ä¸Šä¹Ÿå°±æ˜¯æŠŠä¸¤è¾¹çš„è™šæ‹Ÿå†…å­˜ä¸€èµ·æ˜ å°„åˆ°ä¸€ç‰‡å…±åŒçš„çœŸå†…å­˜ä¸Šã€‚ä½¿ç”¨çš„æ¥å£æœ‰ï¼š</p>
<ol>
<li>ç”Ÿæˆç³»ç»ŸIPCèµ„æºæ ‡è¯†<code>ftok</code></li>
<li>è·å–å…±äº«å†…å­˜<strong>çš„æ ‡è¯†ç¬¦</strong><code>shmget</code></li>
<li>å…³è”å…±äº«å†…å­˜å’Œè™šæ‹Ÿå†…å­˜åœ°å€<code>shmat</code></li>
<li>å–æ¶ˆå…³è”å…±äº«å†…å­˜<code>shmdt</code></li>
</ol>
<p>ä»¥ä¸‹ä¸ºå…±äº«å†…å­˜ä½¿ç”¨çš„å…·ä½“å®ä¾‹ï¼Œçº¿ç¨‹Aå’ŒBé€šè¿‡å…±åŒè¯»å†™<code>/tmp/shm</code>å®ç°æ•°æ®äº¤äº’ã€‚</p>
<p>çº¿ç¨‹Aä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span>  <span class="comment">// ç”³è¯·IPCèµ„æº çš„æ¥å£</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span>  <span class="comment">// å…±äº«å†…å­˜ çš„æ¥å£</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHM_PATH <span class="string">&quot;/tmp/shm&quot;</span> <span class="comment">// å…±äº«å†…å­˜æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHM_SIZE 128        <span class="comment">// ç©ºé—´å¤§å°</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> shmid;  <span class="comment">// å…±äº«å†…å­˜æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="type">char</span> *addr; <span class="comment">// å®é™…æ“ä½œçš„ è™šæ‹Ÿåœ°å€</span></span><br><span class="line">    <span class="type">key_t</span> key = ftok(SHM_PATH, <span class="number">0x6666</span>);  <span class="comment">// IPC èµ„æºå·</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*åˆ›å»º å…±äº«å†…å­˜ æ ‡è¯†ç¬¦*/</span></span><br><span class="line">    shmid = shmget(key, SHM_SIZE, IPC_CREAT|IPC_EXCL|<span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to create share memory\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è·å¾— æ“ä½œçš„è™šæ‹Ÿåœ°å€ */</span></span><br><span class="line">    addr = shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (addr &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to map share memory\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* å¾€å…±äº«å†…å­˜ å†™ */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(addr, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çº¿ç¨‹Bä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span>  <span class="comment">// ç”³è¯·IPCèµ„æº çš„æ¥å£</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span>  <span class="comment">// å…±äº«å†…å­˜ çš„æ¥å£</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHM_PATH <span class="string">&quot;/tmp/shm&quot;</span> <span class="comment">// å…±äº«å†…å­˜æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHM_SIZE 128        <span class="comment">// ç©ºé—´å¤§å°</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> shmid;</span><br><span class="line">    <span class="type">char</span> *addr;</span><br><span class="line">    <span class="type">key_t</span> key = ftok(SHM_PATH, <span class="number">0x6666</span>);  <span class="comment">// IPC èµ„æºå·</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*è·å–ï¼ å…±äº«å†…å­˜ æ ‡è¯†ç¬¦*/</span></span><br><span class="line">    shmid = shmget(key, SHM_SIZE, IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get share memory\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è·å¾— æ“ä½œçš„è™šæ‹Ÿåœ°å€ */</span></span><br><span class="line">    addr = shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (addr &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to map share memory\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* ä»å…±äº«å†…å­˜ è¯» */</span></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, addr, <span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·‘äº†Aè¿›ç¨‹å†è·‘Bè¿›ç¨‹ï¼ŒBä¼šæ‰“å°Aå†™å…¥çš„â€Hello Worldâ€ã€‚</p>
<h3 id="æ‰©å±•è‡ªå®šä¹‰åŠŸèƒ½æ¥å£IOCTL"><a href="#æ‰©å±•è‡ªå®šä¹‰åŠŸèƒ½æ¥å£IOCTL" class="headerlink" title="æ‰©å±•è‡ªå®šä¹‰åŠŸèƒ½æ¥å£IOCTL"></a>æ‰©å±•è‡ªå®šä¹‰åŠŸèƒ½æ¥å£IOCTL</h3><p>ä¸Šé¢è®²åŸºç¡€å­—ç¬¦è®¾å¤‡æ—¶ï¼Œâ€™struct file_operationsâ€™é‡Œå®šä¹‰çš„é™¤äº†å¼€å…³è¯»å†™ç­‰å¸¸è§„æ¥å£ï¼Œè¿˜æœ‰ioctlç›¸å…³çš„æ¥å£ã€‚è¿™æ˜¯å› ä¸ºè‚¯å®šæœ‰ç¡¬ä»¶ä¼šç»†åˆ†å‡ºç‰¹æ®ŠåŠŸèƒ½ï¼Œæ¯”å¦‚æ‰“ä¸€ä¸ªå‘½ä»¤è®©LEDç¯å˜æˆå‘¼å¸ç¯ï¼Œè¿™æ—¶å°±è¦ç”¨åˆ°<code>ioctl</code>æ¥æ‰©å±•æ–°åŠŸèƒ½ã€‚</p>
<p>è¿™ä¸ªioctlæœ‰ä¸¤ä¸ªä½¿ç”¨çš„è§’åº¦ï¼šç”¨æˆ·ï¼ˆæ€&#x2F;ç¨‹åºï¼‰å’Œå†…æ ¸ï¼ˆæ€&#x2F;é©±åŠ¨ï¼‰ã€‚</p>
<ul>
<li><p>ç”¨æˆ·ç¨‹åºè°ƒç”¨ioctlæ¥å‘½ä»¤ç¡¬ä»¶ï¼š</p>
<p>å¦‚ä¸‹æ˜¯ä½¿ç”¨çš„å‡½æ•°åŸå‹ï¼Œç¬¬ä¸€ä¸ªæ˜¯<code>open</code>è®¾å¤‡åå¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¬¬äºŒä¸ªæ˜¯è¿™ä¸ªé©±åŠ¨å‘ŠçŸ¥ç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„å‘½ä»¤ï¼ˆä¸€èˆ¬æ˜¯å®ï¼‰ï¼Œç¬¬ä¸‰ä¸ªæ˜¯é…å¥—çš„å˜é•¿å‚æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ioctl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, ...)</span> ;</span><br></pre></td></tr></table></figure></li>
<li><p>é©±åŠ¨ç¨‹åºå®ç°ioctlçš„ç›¸å…³æ¥å£ï¼š</p>
<p>ä½œä¸ºé©±åŠ¨ç¨‹åºï¼Œåˆ™è´Ÿè´£è§£ææŒ‰çº¦å®šåè®®è§£æç”¨æˆ·å‘ä¸‹æ¥çš„å‘½ä»¤ã€‚ä»<code>file_operations</code>ç»“æ„ä½“å£°æ˜é‡ŒæŠ çš„å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> (*unlocked_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="type">long</span> (*compat_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br></pre></td></tr></table></figure>

<p>éƒ½æ˜¯ioctlï¼Œè¿™ä¸¤ä¸ªæ¥å£çš„åŒºåˆ«æ˜¯å•¥å‘¢ï¼Ÿ</p>
<ul>
<li>unlocked_ioctlï¼šåœ¨æ— å¤§å†…æ ¸é”ï¼ˆBKLï¼‰çš„æƒ…å†µä¸‹è°ƒç”¨</li>
<li>compat_ioctlï¼šå…¼å®¹ç‰ˆï¼ˆcompatibleï¼‰ioctlï¼Œä¸»è¦ç›®çš„æ˜¯ä¸º 64 ä½ç³»ç»Ÿæä¾› 32 ä½ ioctl çš„å…¼å®¹æ–¹æ³•ï¼Œä¹Ÿæ˜¯åœ¨æ— å¤§å†…æ ¸é”çš„æƒ…å†µä¸‹è°ƒç”¨</li>
</ul>
<p>å†çœ‹å‚æ•°ï¼Œç”¨æˆ·æ€é‡Œè°ƒç”¨<code>ioctl</code>çš„å‚æ•°é€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œä¾æ¬¡å¯¹åº”äºä¸Šé¢ä¸¤ä¸ªæ¥å£çš„å‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯<code>fd</code>ï¼Œç¬¬äºŒä¸ªæ˜¯<code>cmd</code>ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å˜é•¿æ•°æ®çš„æŒ‡é’ˆã€‚<br>è¯´åˆ°å‘½ä»¤<code>cmd</code>ï¼Œåœ¨è®¾è®¡é©±åŠ¨ç¨‹åºæ—¶ï¼Œå¹¶ä¸æ˜¯å®å®šä¹‰ï¼ˆdefineï¼‰å‘½ä»¤ä»¬ä¸º1ã€2ã€3â€¦è¿™æ ·çš„intæ•°æ®ï¼ŒLinuxåˆ¶å®šäº†ä¸€ä¸ªç”Ÿæˆcmdçš„æ ‡å‡†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IOC(dir,type,nr,size) \</span></span><br><span class="line"><span class="meta">  (((dir)  &lt;&lt; _IOC_DIRSHIFT) | \</span></span><br><span class="line"><span class="meta">   ((type) &lt;&lt; _IOC_TYPESHIFT) | \</span></span><br><span class="line"><span class="meta">   ((nr)   &lt;&lt; _IOC_NRSHIFT) | \</span></span><br><span class="line"><span class="meta">   ((size) &lt;&lt; _IOC_SIZESHIFT))</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>dir</strong>ï¼ˆdirectionï¼‰ï¼Œæ ‡å¿—æ•°æ®æ–¹å‘ï¼Œå æ®2bitï¼Œå–å€¼ä¸ºï¼š<ul>
<li>_IOC_NONEï¼šæ— æ•°æ®</li>
<li>_IOC_READï¼šè¯»æ•°æ®</li>
<li>_IOC_WRITEï¼šå†™æ•°æ®</li>
<li>_IOC_READ | _IOC_WRITEï¼šè¯»å†™æ•°æ®</li>
</ul>
</li>
<li><strong>type</strong>ï¼ˆdevice typeï¼‰ï¼Œè®¾å¤‡ç±»å‹ï¼Œå æ®8bitï¼Œå¯ä»¥ä¸ºä»»æ„ASCIIç ï¼Œä½œç”¨æ˜¯ä½¿å‘½ä»¤æœ‰å”¯ä¸€çš„è®¾å¤‡æ ‡è¯†</li>
<li><strong>nr</strong>ï¼ˆnumberï¼‰ï¼Œå‘½ä»¤ç¼–å·&#x2F;åºæ•°ï¼Œå æ®8bitï¼Œå–å€¼èŒƒå›´ 0~255</li>
<li><strong>size</strong>ï¼Œæ¶‰åŠåˆ°ioctlæ¥å£çš„ç¬¬ä¸‰ä¸ªå¯è¾¹é•¿å‚æ•°argï¼Œå æ®13bitæˆ–è€…14bitï¼ˆä½“ç³»ç›¸å…³ï¼ŒARMæ¶æ„ä¸€èˆ¬ä¸º14ä½ï¼‰ï¼ŒæŒ‡å®šargçš„æ•°æ®ç±»å‹åŠé•¿åº¦ï¼ˆå¦‚æœåœ¨é©±åŠ¨ioctlå®ç°ä¸­ä¸æ£€æŸ¥ï¼Œå¯ä»¥å¿½ç•¥è¯¥å‚æ•°ï¼‰</li>
</ul>
<p>æ—¢ç„¶æœ‰ç¼–ç ï¼Œè‚¯å®šå°±æœ‰è§£ç ï¼ŒLinuxæä¾›å¯¹åº”çš„è§£ç æ–¹æ³•ï¼ˆå®ï¼‰ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IOC_DIR(nr)        (((nr) &gt;&gt; _IOC_DIRSHIFT) &amp; _IOC_DIRMASK)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IOC_TYPE(nr)       (((nr) &gt;&gt; _IOC_TYPESHIFT) &amp; _IOC_TYPEMASK)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IOC_NR(nr)     (((nr) &gt;&gt; _IOC_NRSHIFT) &amp; _IOC_NRMASK)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IOC_SIZE(nr)       (((nr) &gt;&gt; _IOC_SIZESHIFT) &amp; _IOC_SIZEMASK)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>æœ€åï¼Œæ€»ç»“ä¸€ä¸‹ioctlçš„ä½¿ç”¨å…¨æµç¨‹ï¼š</p>
<ol>
<li>é˜…è¯»ç¡¬ä»¶å¤–è®¾çš„æŠ€æœ¯æ‰‹å†Œ</li>
<li>ç¡®å®šè¦å®ç°çš„ç»†åˆ†åŠŸèƒ½ï¼Œå¼€ä¸€ä¸ªå¤´æ–‡ä»¶ï¼ŒåŸºäº<code>_IOC</code>é€ä¸ªåŠŸèƒ½å®šä¹‰cmdå€¼</li>
<li>å®ç°<code>unlocked_ioctl</code>ï¼Œ<code>compat_ioctl</code>ï¼›åœ¨é‡Œé¢è§£æåŒ¹é…cmdå€¼ï¼Œæ‰§è¡Œå¯¹åº”çš„ç¡¬ä»¶æ“ä½œ</li>
<li>å°†å®ç°çš„<code>unlocked_ioctl</code>ä¸¤ä¸ªæ¥å£ï¼Œé€šè¿‡å‡½æ•°æŒ‡é’ˆçš„å½¢å¼èµ‹å€¼ç»™<code>file_operations</code>ç»“æ„ä½“</li>
<li>æ­£å¦‚â€œå°è¯•ç‰›åˆ€â€ç« èŠ‚ä¸­ï¼Œç”³è¯·ã€æ³¨å†Œé©±åŠ¨ï¼Œåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</li>
<li>ç”¨æˆ·ä½¿ç”¨<code>open</code>æ¥å£æ‰“å¼€è®¾å¤‡ï¼Œè°ƒç”¨<code>ioctl</code>æ‰§è¡Œç›¸åº”çš„<code>cmd</code>ã€‚</li>
</ol>
<p>å…·ä½“çš„æ¼”ç¤ºï¼Œæˆ‘ä»¬æœ‰3ä¸ªæ–‡ä»¶ï¼š<code>demo.c</code>é©±åŠ¨æºç æ–‡ä»¶ï¼Œ<code>test.c</code>ç”¨æˆ·æºç æ–‡ä»¶ï¼Œ<code>chrdev.h</code>å¤´æ–‡ä»¶ã€‚è¯·è¯»è€…è‡ªè¡Œå­¦ä¹ ï¼š</p>
<ul>
<li><p>demo.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chrdev.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_LED_NUM 4</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> major;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name = <span class="string">&quot;demoname&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">cls</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> led_gpio_id[MY_LED_NUM] = &#123;</span><br><span class="line">  (<span class="number">1</span>*<span class="number">32</span>+<span class="number">4</span>),	<span class="comment">/* GPIO1_4 */</span></span><br><span class="line">  (<span class="number">1</span>*<span class="number">32</span>+<span class="number">5</span>),	<span class="comment">/* GPIO1_5 */</span></span><br><span class="line">  (<span class="number">1</span>*<span class="number">32</span>+<span class="number">6</span>),</span><br><span class="line">  (<span class="number">1</span>*<span class="number">32</span>+<span class="number">7</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">gpio</span> <span class="title">led_struct</span>[<span class="title">MY_LED_NUM</span>] =</span>&#123;</span><br><span class="line">  &#123;(<span class="number">1</span>*<span class="number">32</span>+<span class="number">4</span>), <span class="number">0</span>, <span class="string">&quot;led1&quot;</span>&#125;,</span><br><span class="line">  &#123;(<span class="number">1</span>*<span class="number">32</span>+<span class="number">5</span>), <span class="number">0</span>, <span class="string">&quot;led2&quot;</span>&#125;,</span><br><span class="line">  &#123;(<span class="number">1</span>*<span class="number">32</span>+<span class="number">6</span>), <span class="number">0</span>, <span class="string">&quot;led3&quot;</span>&#125;,</span><br><span class="line">  &#123;(<span class="number">1</span>*<span class="number">32</span>+<span class="number">7</span>), <span class="number">0</span>, <span class="string">&quot;led4&quot;</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">demo_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">  printk(<span class="string">&quot;%s -- %d.\n&quot;</span>, __FUNCTION__, __LINE__);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">demo_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">  printk(<span class="string">&quot;%s -- %d.\n&quot;</span>, __FUNCTION__, __LINE__);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">demo_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *userbuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">  printk(<span class="string">&quot;%s -- %d.\n&quot;</span>, __FUNCTION__, __LINE__);</span><br><span class="line">  <span class="comment">//copy_to_user(void __user * to, const void * from, size_t n);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">demo_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *userbuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">  printk(<span class="string">&quot;%s -- %d.\n&quot;</span>, __FUNCTION__, __LINE__);</span><br><span class="line">  <span class="comment">//copy_from_user(void * to, const void __user * from, unsigned long n);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">demo_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> args)</span></span><br><span class="line">&#123;	</span><br><span class="line">  <span class="type">led_node_t</span> <span class="type">led_t</span>;</span><br><span class="line">  <span class="type">int</span> ret, led_num;</span><br><span class="line"></span><br><span class="line">  ret = copy_from_user(&amp;<span class="type">led_t</span>, (<span class="type">led_node_t</span> *)args, <span class="keyword">sizeof</span>(<span class="type">led_t</span>));	<span class="comment">//æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›æœ‰å¤šå°‘ä¸ªBytesæœªå®Œæˆcopyã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (ret)</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;copy_from_user failed.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printk(<span class="string">&quot;%s -- %d.\n&quot;</span>, __FUNCTION__, __LINE__);</span><br><span class="line"></span><br><span class="line">  led_num = <span class="type">led_t</span>.which;</span><br><span class="line">  <span class="keyword">switch</span>(cmd)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> LEDON:</span><br><span class="line">    <span class="keyword">if</span> (led_num == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;led%d on.\n&quot;</span>, led_num);</span><br><span class="line">      gpio_set_value(led_gpio_id[led_num<span class="number">-1</span>], <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (led_num == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;led%d on.\n&quot;</span>, led_num);</span><br><span class="line">      gpio_set_value(led_gpio_id[led_num<span class="number">-1</span>], <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (led_num == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;led%d on.\n&quot;</span>, led_num);</span><br><span class="line">      gpio_set_value(led_gpio_id[led_num<span class="number">-1</span>], <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (led_num == <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;led%d on.\n&quot;</span>, led_num);</span><br><span class="line">      gpio_set_value(led_gpio_id[led_num<span class="number">-1</span>], <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> LEDOFF:</span><br><span class="line">    <span class="keyword">if</span> (led_num == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;led%d off.\n&quot;</span>, led_num);</span><br><span class="line">      gpio_set_value(led_gpio_id[led_num<span class="number">-1</span>], <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (led_num == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;led%d off.\n&quot;</span>, led_num);</span><br><span class="line">      gpio_set_value(led_gpio_id[led_num<span class="number">-1</span>], <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (led_num == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;led%d off.\n&quot;</span>, led_num);</span><br><span class="line">      gpio_set_value(led_gpio_id[led_num<span class="number">-1</span>], <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (led_num == <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;led%d off.\n&quot;</span>, led_num);</span><br><span class="line">      gpio_set_value(led_gpio_id[led_num<span class="number">-1</span>], <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    printk(<span class="string">&quot;cmd id error.\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err0:</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">fops</span> =</span> &#123;</span><br><span class="line">  .open = demo_open,</span><br><span class="line">  .release = demo_release,</span><br><span class="line">  .read = demo_read,</span><br><span class="line">  .write = demo_write,</span><br><span class="line">  .unlocked_ioctl = demo_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i, retval;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;MY_LED_NUM; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    retval = gpio_is_valid(led_gpio_id[i]);</span><br><span class="line">    <span class="keyword">if</span> (retval == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;gpio is not valid.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err0;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  retval = gpio_request_array(led_struct, MY_LED_NUM);</span><br><span class="line">  <span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;retvla = %d.\n&quot;</span>, retval);</span><br><span class="line">    printk(<span class="string">&quot;gpio_request_array failed.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;MY_LED_NUM; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    gpio_direction_output(led_gpio_id[i], <span class="number">0</span>);	<span class="comment">// å°†å¼•è„šè®¾ç½®ä¸ºè¾“å‡ºï¼Œå¹¶åˆå§‹åŒ–ä¸ºä½ç”µå¹³</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">err1:</span><br><span class="line">  <span class="keyword">return</span> retval;</span><br><span class="line">err0:</span><br><span class="line">  <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">demo_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  printk(<span class="string">&quot;%s -- %d.\n&quot;</span>, __FUNCTION__, __LINE__);</span><br><span class="line"></span><br><span class="line">  major = register_chrdev(<span class="number">0</span>, name, &amp;fops);</span><br><span class="line">  <span class="keyword">if</span> (major &lt;= <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;register_chrdev failed.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cls = class_create(THIS_MODULE, <span class="string">&quot;char_class&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (cls == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;class_create failed.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dev = device_create(cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="string">&quot;chrdev%d&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (dev ==<span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;device_create failed.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  led_init();	<span class="comment">// è®¾ç½®ä¸ºè¾“å‡ºæ¨¡å¼</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err2:</span><br><span class="line">  class_destroy(cls);</span><br><span class="line">err1:</span><br><span class="line">  unregister_chrdev(major, name);</span><br><span class="line">err0:</span><br><span class="line">  <span class="keyword">return</span> major;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">demo_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  printk(<span class="string">&quot;%s -- %d.\n&quot;</span>, __FUNCTION__, __LINE__);</span><br><span class="line"></span><br><span class="line">  gpio_free_array(led_struct, MY_LED_NUM);</span><br><span class="line"></span><br><span class="line">  device_destroy(cls, MKDEV(major, <span class="number">0</span>));</span><br><span class="line">  class_destroy(cls);</span><br><span class="line">  unregister_chrdev(major, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(demo_init);</span><br><span class="line">module_exit(demo_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>test.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chrdev.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *pathname = <span class="string">&quot;/dev/chrdev0&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED_NUM 4</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fd, i;</span><br><span class="line">  <span class="type">led_node_t</span> led;</span><br><span class="line"></span><br><span class="line">  fd = open(pathname, O_RDWR, <span class="number">0666</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt;= <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;open failed.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;=LED_NUM; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    led.which  = i;</span><br><span class="line">    </span><br><span class="line">    led.status = <span class="number">0</span>; <span class="comment">// 0è¡¨ç¤ºç­</span></span><br><span class="line">    ioctl(fd, LEDOFF, &amp;led);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    led.status = <span class="number">1</span>;	<span class="comment">// 1è¡¨ç¤ºäº®</span></span><br><span class="line">    ioctl(fd, LEDON, &amp;led);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(fd);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>chrdev.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _CHRDEV_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _CHRDEV_H_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">led_node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">int</span> which;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line">&#125;<span class="type">led_node_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED_MAGIC <span class="string">&#x27;q&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDON  _IOW(LED_MAGIC, 0, struct led_node)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDOFF _IOW(LED_MAGIC, 1, struct led_node)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* chrdev.h */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="å¹³å°ï¼Ÿæ€»çº¿ï¼Ÿé©±åŠ¨ï¼Ÿè®¾å¤‡ï¼Ÿ"><a href="#å¹³å°ï¼Ÿæ€»çº¿ï¼Ÿé©±åŠ¨ï¼Ÿè®¾å¤‡ï¼Ÿ" class="headerlink" title="å¹³å°ï¼Ÿæ€»çº¿ï¼Ÿé©±åŠ¨ï¼Ÿè®¾å¤‡ï¼Ÿ"></a>å¹³å°ï¼Ÿæ€»çº¿ï¼Ÿé©±åŠ¨ï¼Ÿè®¾å¤‡ï¼Ÿ</h3><blockquote>
<p>ç¬”è€…å¹ï¼šå­¦åˆ°è¿™ä¸€å…³ï¼ŒçœŸä¸å®¹æ˜“å•Š~ğŸ¤¯é©¬ä¸Šå°±è¦æ‹¿ä¸‹Linuxé©±åŠ¨çš„æœ€åä¸€å—é«˜åœ°äº†ï¼</p>
</blockquote>
<p>å› ä¸ºLinuxå‘å±•çš„å¤ªå¥½äº†ï¼ŒLinuxåœ¨æœåŠ¡å™¨ã€PCæœºã€åµŒå…¥å¼éƒ½å¯æˆ˜å¯ä¸ºï¼Œéšç€ç°ä»£æ•°å­—ç³»ç»Ÿè¶Šæ¥è¶Šå¤æ‚ï¼Œæ¥å…¥CPUçš„å¤–è®¾è¶Šæ¥è¶Šå¤šï¼Œæ¥å£ç§ç±»ä¹Ÿå„ä¸å°½ç›¸åŒï¼Œåœ¨<code>/dev/</code>ç›®å½•ä¸­æ˜ å°„è®¾å¤‡èŠ‚ç‚¹çš„æ–¹æ³•ï¼Œçœ‹çš„äººçœ¼èŠ±ç¼­ä¹±ï¼Œåœ¨ç®¡ç†é©±åŠ¨ä¸Šé€ æˆäº†æå¤§çš„ä¸ä¾¿ã€‚å› æ­¤ç±»ä¼¼Windowsçš„<strong>è®¾å¤‡ç®¡ç†å™¨</strong>ï¼ŒLinuxé‡‡ç”¨<strong>æ€»çº¿</strong>ï¼ˆBusï¼‰æ¨¡å‹æ¥æè¿°å’Œç®¡ç†ï¼Œå¹¶ä¸”æ˜ å°„åœ¨äº†æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå¯ä»¥æŸ¥çœ‹<code>/sys/bus/</code>ç›®å½•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> /sys/bus/</span><br><span class="line"></span><br><span class="line">ac97         edac          machinecheck  parport      sdio     workqueue</span><br><span class="line">acpi         eisa          mdio_bus      pci          serial   xen</span><br><span class="line">cec          event_source  memory        pci-epf      serio    xen-backend</span><br><span class="line">clockevents  gameport      mipi-dsi      pci_express  snd_seq</span><br><span class="line">clocksource  gpio          mmc           platform     spi</span><br><span class="line">container    hid           nd            pnp          usb</span><br><span class="line">cpu          i2c           node          rapidio      virtio</span><br><span class="line">dax          isa           nvmem         scsi         vme</span><br></pre></td></tr></table></figure>

<p>çœ¼å°–çš„ç¡¬ä»¶é€‰æ‰‹ï¼Œå·²ç»å‘ç°è¿™é‡Œçš„å­é¡¹å°±æ˜¯ä¸€ä¸ªä¸ªæ€»çº¿åå­—ï¼Œè€³ç†Ÿèƒ½è¯¦çš„å¦‚ï¼šUSBã€PCIã€SPIã€‚å†éšä¾¿æŒ‘ä¸€ä¸ªå­é¡¹<code>ls</code>æˆ–è€…<code>tree</code>å±•å¼€çœ‹çœ‹ï¼Œå‘ç°æ¯ä¸ªé‡Œå¤´éƒ½æ˜¯ç»Ÿä¸€çš„2ä¸ªæ–‡ä»¶å¤¹ï¼ˆdevicesã€driversï¼‰+3ä¸ªæ–‡ä»¶ï¼ˆdrivers_autoprobeã€drivers_probeã€ueventï¼‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ tree -L2 /sys/bus</span><br><span class="line"></span><br><span class="line">/sys/bus</span><br><span class="line">â”œâ”€â”€ spi</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ devices</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ drivers</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ drivers_autoprobe</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ drivers_probe</span><br><span class="line">â”‚Â Â  â””â”€â”€ uevent</span><br><span class="line">â”œâ”€â”€ usb</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ devices</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ drivers</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ drivers_autoprobe</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ drivers_probe</span><br><span class="line">â”‚Â Â  â””â”€â”€ uevent</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¯»è€…æŸ¥çœ‹<em>iic</em>æ€»çº¿ä¸‹çš„<em>devices</em>å’Œ<em>drivers</em>ï¼Œå¹¶å’Œç¬”è€…ä¸€æ ·åœ¨è™šæ‹Ÿæœºé‡Œè·‘çš„<em>Ubuntu</em>ä¼šå‘ç°ï¼šåœ¨driversç›®å½•ä¸‹æœ‰å¾ˆå¤šä¸åŒçš„é¡¹ï¼ˆé©±åŠ¨ç¨‹åºï¼‰ï¼Œä½†devicesæ˜¯ç©ºçš„ã€‚å†è§‚å¯Ÿ<em>cpu</em>æ€»çº¿çš„<em>devices</em>å’Œ<em>drivers</em>ï¼Œä¼šå‘ç°driversé‡Œåªæœ‰ä¸€ä¸ªprocessorï¼Œè€Œdevicesé‡Œæœ‰å¾ˆå¤šä¸ªcpuã€‚</p>
<p>æ­¤æ—¶ï¼Œè¯»è€…åº”è¯¥å¯¹è¿™ä¸ªLinuxçš„â€œé©±åŠ¨&amp;è®¾å¤‡ç®¡ç†å™¨â€æœ‰äº›ç›´è§‰ä¸Šçš„è®¤çŸ¥äº†å§ï¼Ÿ</p>
<p>æ²¡é”™ï¼Œæ­£å¦‚ä¸‹å›¾ï¼ˆçš„ä¸Šéƒ¨åˆ†ï¼‰æ‰€ç»˜åˆ¶çš„</p>
<ol>
<li>Linux<strong>æ€»çº¿ï¼ˆBusï¼‰æ¨¡å‹</strong>å°†æ‰€æœ‰å†…å®¹å…ˆæ˜¯æŒ‰ç…§<strong>é€šä¿¡æ€»çº¿</strong>è¿›è¡Œåˆ†ç±»ï¼ˆå› ä¸ºåŒç±»çš„æ€»çº¿ï¼Œå¾€å¾€æœ‰å¾ˆå¤šå…±æ€§ï¼Œè¿™æ˜¯OOPæ€æƒ³ï¼‰ï¼›</li>
<li>æ¥ç€åœ¨æ¯ä¸ªæ€»çº¿ä¸‹åˆ’åˆ†äº†<strong>é©±åŠ¨ï¼ˆDriverï¼‰</strong>å’Œ<strong>è®¾å¤‡ï¼ˆDeviceï¼‰</strong></li>
<li>æŠŠæ‰€æœ‰å®‰è£…çš„é©±åŠ¨ç¨‹åºï¼ˆåŒ…æ‹¬ä½¿ç”¨ä¸­çš„ã€æœªæ¥ä½¿ç”¨çš„ï¼‰ï¼Œæ”¾åˆ°<strong>Driver</strong>ç›®å½•ä¸‹ï¼›</li>
<li>æŠŠå®é™…æ£€æµ‹åˆ°æ’å…¥çš„è®¾å¤‡ï¼Œæˆ–è™šæ‹Ÿçš„è®¾å¤‡ï¼Œæ³¨å†Œåæ”¾åˆ°<strong>Device</strong>ä¸‹ï¼›</li>
</ol>
<p>è¿™æ ·åšçš„å¥½å¤„æœ‰ï¼š</p>
<ul>
<li>æ•´ä½“ç»“æ„æ¸…æ™°ï¼Œæ–¹ä¾¿æŸ¥æ‰¾</li>
<li>å¤šä¸ªç›¸åŒçš„è®¾å¤‡æ¥å…¥ï¼Œå…±ç”¨ä¸€ä¸ªé©±åŠ¨ç¨‹åºï¼ˆæ¯”å¦‚3ä¸ªä¸€æ ·çš„MP3é€šè¿‡USBä¸€èµ·æ’åˆ°ç”µè„‘ï¼‰ï¼Œç‰¹å®šå‚æ•°åœ¨deviceä¸­ï¼Œä¸åœ¨driverä¸­ï¼Œé€‚åº”æ€§æ›´å¼º</li>
</ul>
<p>ä½†æœ‰ä¸ªç‰¹æ®Šæƒ…å†µï¼Œæœ‰äº›è®¾å¤‡æœ¬èº«æ˜¯æ²¡æœ‰æ€»çº¿çš„ã€‚æ¯”å¦‚LEDï¼Œå°±æ˜¯SoCçš„ä¸€ä¸ªGPIOå£å­ã€‚æ‰€ä»¥Linuxæä¾›äº†ä¸€ä¸ªä¸“é—¨æ”¾æ‚ç‰©çš„æ€»çº¿â€”â€”<strong>å¹³å°platform</strong>ã€‚ä¸‹å›¾å®Œæ•´åœ°å±•ç¤ºäº† æ€»çº¿æ¨¡å‹ä¸‹çš„ platformæ€»çº¿ä¸‹çš„ é©±åŠ¨å’Œè®¾å¤‡ åˆ†åˆ«æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<p><img src="http://imgjry.fangyikuan.xyz/20230222/20230222-Linux-8.png" alt="platform"></p>
<p>NOTEï¼šè¿™è¾¹å¼•ç”¨äº†å¤§ä½¬â€œç«å±±ä¸Šçš„ä¼é¹…â€å‘è¡¨äºCSDNä¸Šçš„æ–‡ç« <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_16504163/article/details/118562670">ä¸€å¼ å›¾æŒæ¡ Linux platform å¹³å°è®¾å¤‡é©±åŠ¨æ¡†æ¶</a></p>
<hr>
<p>åˆ†æ¸…æ¥šäº†æ€»çº¿ã€å¹³å°ã€é©±åŠ¨ã€è®¾å¤‡è¿™4ä¸ªæ¦‚å¿µåï¼Œæˆ‘ä»¬æ¥çœ‹å…·ä½“åŸç†å’Œå¦‚ä½•ä½¿ç”¨ï¼š</p>
<h4 id="æ€»çº¿åŸç†"><a href="#æ€»çº¿åŸç†" class="headerlink" title="æ€»çº¿åŸç†"></a>æ€»çº¿åŸç†</h4><p>Linuxå†…æ ¸å®ç°<strong>æ€»çº¿</strong>çš„æ–¹å¼æ˜¯ï¼Œç®¡ç†ä¸¤ä¸ªé“¾è¡¨ï¼šè®¾å¤‡é“¾è¡¨ã€é©±åŠ¨é“¾è¡¨ã€‚</p>
<ul>
<li>å‘å†…æ ¸æ³¨å†Œä¸€ä¸ªé©±åŠ¨æ—¶ï¼Œä¾¿æ’å…¥åˆ°æ€»çº¿çš„<strong>é©±åŠ¨é“¾è¡¨</strong>ã€‚</li>
<li>å‘å†…æ ¸æ³¨å†Œä¸€ä¸ªè®¾å¤‡æ—¶ï¼Œä¾¿æ’å…¥åˆ°æ€»çº¿çš„<strong>è®¾å¤‡é“¾è¡¨</strong>ã€‚</li>
<li>åœ¨æ’å…¥é“¾è¡¨åï¼ˆé©±åŠ¨å’Œè®¾å¤‡éƒ½ä¼šï¼‰ï¼Œæ€»çº¿ä¼šæ‰§è¡Œ<code>bus_type</code>ç»“æ„ä½“ä¸­çš„<code>match</code>æ–¹æ³•å¯¹æ–°æ’å…¥çš„ è®¾å¤‡&#x2F;é©±åŠ¨ è¿›è¡ŒåŒ¹é…ã€‚ï¼ˆä»¥<code>name</code>åå­—çš„æ–¹å¼åŒ¹é…ï¼Œå…·ä½“è§ä¸Šé¢å¤§å›¾ä¸­çš„è°ƒç”¨ï¼‰</li>
<li>åŒ¹é…æˆåŠŸåï¼Œä¼šè°ƒç”¨æ³¨å†Œé©±åŠ¨æ—¶<code>device_driver</code>ç»“æ„ä½“ä¸­çš„<code>probe</code>æ–¹æ³•ã€‚</li>
<li>åŒç†ï¼Œç§»é™¤è®¾å¤‡æˆ–é©±åŠ¨æ—¶ï¼Œè°ƒç”¨<code>device_driver</code>ç»“æ„ä½“ä¸­çš„<code>remove</code>æ–¹æ³•ã€‚</li>
</ul>
<h4 id="æ€»çº¿çš„ä½¿ç”¨"><a href="#æ€»çº¿çš„ä½¿ç”¨" class="headerlink" title="æ€»çº¿çš„ä½¿ç”¨"></a>æ€»çº¿çš„ä½¿ç”¨</h4><ul>
<li>ç›¸å…³æ•°æ®ç±»å‹ï¼š<ul>
<li>æ€»çº¿ç»“æ„ä½“ï¼š <code>bus_type</code></li>
<li>è®¾å¤‡ç»“æ„ä½“ï¼š <code>device</code></li>
<li>é©±åŠ¨ç»“æ„ä½“ï¼š <code>device_driver</code></li>
</ul>
</li>
<li>ç›¸å…³æ¥å£ï¼š<ul>
<li>æ³¨å†Œæ€»çº¿ï¼š<code>bus_register</code>ã€‚å…¶å®Linuxå·²ç»ç¼–å¥½äº†å¤§éƒ¨åˆ†çš„æ€»çº¿é©±åŠ¨</li>
<li>æ³¨é”€æ€»çº¿ï¼š<code>bus_unregister</code></li>
<li>æ³¨å†Œè®¾å¤‡ï¼š<code>device_register</code></li>
<li>æ³¨é”€è®¾å¤‡ï¼š<code>device_unregister</code></li>
<li>æ³¨å†Œé©±åŠ¨ï¼š<code>driver_register</code></li>
<li>æ³¨é”€é©±åŠ¨ï¼š<code>driver_unregister</code></li>
</ul>
</li>
</ul>
<p>è€ƒè™‘åˆ°ä½¿ç”¨è¿‡ç¨‹å’Œå¹³å°æ€»çº¿å¾ˆç›¸ä¼¼ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæ­¤å¤„ä¸ä¸Šä»£ç ï¼Œè¯»è€…çœ‹ä¸‹å°èŠ‚çš„ä»£ç å°±æ‡‚äº†ã€‚</p>
<h4 id="å¹³å°æ€»çº¿ï¼ˆplatform-busï¼‰ä½¿ç”¨"><a href="#å¹³å°æ€»çº¿ï¼ˆplatform-busï¼‰ä½¿ç”¨" class="headerlink" title="å¹³å°æ€»çº¿ï¼ˆplatform busï¼‰ä½¿ç”¨"></a>å¹³å°æ€»çº¿ï¼ˆplatform busï¼‰ä½¿ç”¨</h4><ul>
<li><p>é©±åŠ¨</p>
<ol>
<li>å¡«å……<code>struct platform_driver</code></li>
<li>å‘ç³»ç»Ÿæ³¨å†Œé©±åŠ¨<code>platform_driver_register</code></li>
<li>æ³¨é”€é©±åŠ¨<code>platform_driver_unregister</code></li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//btn_drv.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;btn_desc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//1ï¼‰å¡«å…… struct platform_driver  çš„å„ä¸ªæˆå‘˜:  .probe = btn_probe</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">btn_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;call %s\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1ï¼‰å¡«å…… struct platform_driver  çš„å„ä¸ªæˆå‘˜:  .remove = btn_remove</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">btn_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;call %s\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1ï¼‰å¡«å…… struct platform_driver  çš„å„ä¸ªæˆå‘˜:  ç»‘å®š</span></span><br><span class="line"><span class="comment">//ç»§æ‰¿äºdevice_driverçš„ platform_driver è®¾å¤‡é©±åŠ¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">btn_drv</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//struct device_driver driver</span></span><br><span class="line">    .driver =</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;mybuttons&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//int (*probe)(struct platform_device *)</span></span><br><span class="line">    .probe = btn_probe,</span><br><span class="line">    <span class="comment">//int (*remove)(struct platform_device *)</span></span><br><span class="line">    .remove = btn_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2ï¼‰å‘ç³»ç»Ÿæ³¨å†Œé©±åŠ¨ï¼šplatform_driver_register</span></span><br><span class="line"><span class="type">int</span> __init <span class="title function_">btn_drv_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    platform_driver_register(&amp;btn_drv);  <span class="comment">//1.å‘devä¸­åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ 2.ä¸deviceè®¾å¤‡åŒ¹é…</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3ï¼‰æ³¨é”€é©±åŠ¨ï¼šplatform_driver_unregister</span></span><br><span class="line"><span class="type">void</span> __exit <span class="title function_">btn_drv_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    platform_driver_unregister(&amp;btn_drv);</span><br><span class="line">&#125;</span><br><span class="line">module_init(btn_drv_init);</span><br><span class="line">module_exit(btn_drv_exit);</span><br></pre></td></tr></table></figure>
</li>
<li><p>è®¾å¤‡</p>
<ol>
<li>å¡«å……<code>struct platform_device</code></li>
<li>å‘ç³»ç»Ÿæ³¨å†Œè®¾å¤‡<code>platform_device_register</code></li>
<li>æ³¨é”€è®¾å¤‡<code>platform_device_unregister</code></li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//btn_dev.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/input.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mach/platform.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;btn_desc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//1) å¡«å…… struct platform_device çš„å„ä¸ªæˆå‘˜ï¼šåˆå§‹åŒ– resource ç»“æ„å˜é‡ã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">resource</span> <span class="title">btn_resource</span>[]=</span></span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        .start = IRQ_GPIO_A_START + <span class="number">28</span>,</span><br><span class="line">        .end   = IRQ_GPIO_A_START + <span class="number">28</span>,  <span class="comment">//å¯ä»¥ä¸èµ‹å€¼</span></span><br><span class="line">        .flags = IORESOURCE_IRQ,         <span class="comment">//ä¸­æ–­ç±»å‹èµ„æº</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .start = IRQ_GPIO_B_START + <span class="number">30</span>,</span><br><span class="line">        .end   = IRQ_GPIO_B_START + <span class="number">30</span>,  <span class="comment">//å¯ä»¥ä¸èµ‹å€¼</span></span><br><span class="line">        .flags = IORESOURCE_IRQ,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1) å¡«å…… struct platform_device çš„å„ä¸ªæˆå‘˜ï¼šåˆå§‹åŒ– ç§æœ‰èµ„æº ç»“æ„å˜é‡ã€‚</span></span><br><span class="line"><span class="type">btn_desc_t</span> buttons[] =  <span class="comment">//ç§æœ‰èµ„æºï¼Œæè¿°ä¿¡æ¯</span></span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="string">&quot;up&quot;</span>,   PAD_GPIO_A+<span class="number">28</span>, KEY_UP&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;down&quot;</span>, PAD_GPIO_B+<span class="number">30</span>, KEY_DOWN&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1) å¡«å…… struct platform_device çš„å„ä¸ªæˆå‘˜ï¼š  æ³¨é”€è®¾å¤‡æ—¶ï¼Œè°ƒç”¨</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">btn_release</span><span class="params">(<span class="keyword">struct</span> device *dev)</span>  </span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;call %s\n&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1) å¡«å…… struct platform_device çš„å„ä¸ªæˆå‘˜ï¼š</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> <span class="title">btn_dev</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">    .name = <span class="string">&quot;mybuttons&quot;</span>,</span><br><span class="line">    .dev =</span><br><span class="line">    &#123;</span><br><span class="line">        .release = btn_release,</span><br><span class="line">        .platform_data = (<span class="type">void</span> *)buttons,  <span class="comment">//ç§æœ‰ï¼Œå¹³å°è®¾å¤‡æ€»çº¿</span></span><br><span class="line">    &#125;,</span><br><span class="line">    .resource = btn_resource,</span><br><span class="line">    .num_resources = ARRAY_SIZE(btn_resource), <span class="comment">//èµ„æºä¸ªæ•°</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2ï¼‰å‘ç³»ç»Ÿæ³¨å†Œè®¾å¤‡ï¼šplatform_device_register</span></span><br><span class="line"><span class="type">int</span> __init <span class="title function_">btn_dev_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    platform_device_register(&amp;btn_dev);  <span class="comment">//1.å‘devä¸­åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ 2.ä¸driverè®¾å¤‡åŒ¹é…</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3ï¼‰æ³¨é”€è®¾å¤‡ï¼šplatform_device_unregister</span></span><br><span class="line"><span class="type">void</span> __exit <span class="title function_">btn_dev_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    platform_device_unregister(&amp;btn_dev);</span><br><span class="line">&#125;</span><br><span class="line">module_init(btn_dev_init);</span><br><span class="line">module_exit(btn_dev_exit);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="è®¾å¤‡æ ‘Device-Tree"><a href="#è®¾å¤‡æ ‘Device-Tree" class="headerlink" title="è®¾å¤‡æ ‘Device Tree"></a>è®¾å¤‡æ ‘Device Tree</h2><p>ä¸ºä»€ä¹ˆè®¾å¤‡æ ‘æ”¾æœ€åå‘¢ï¼Ÿå› ä¸ºè®¾å¤‡æ ‘å…¶å®ç”¨çš„æœ€å¤šï¼Œæ”¹èµ·æ¥ç®€å•æ–¹ä¾¿ï¼ˆå¯¹ç€Datasheetè¾“å‚æ•°ï¼‰ï¼Œä½†æ˜¯å‡ºbugçš„æ—¶å€™ï¼Œå‰é¢çš„æ‰€æœ‰çŸ¥è¯†ç¼ºä¸€ä¸å¯ã€‚</p>
<p>è®¾å¤‡æ ‘ä½œç”¨ï¼šç¡¬ä»¶ç»†èŠ‚ä¸å†™é©±åŠ¨é‡Œï¼Œå¤–è®¾æ•°é‡ã€å‚æ•°å’Œæ€»çº¿æ‹“æ‰‘å…³ç³»ç­‰ï¼Œæ”¾è®¾å¤‡æ ‘é‡Œéšæ”¹éšç”¨ï¼Œæé«˜äº†çµæ´»æ€§å’Œå†…æ ¸çš„æ•´æ´æ€§ã€‚</p>
<blockquote>
<p>å…³äºè®¾å¤‡æ ‘åœ¨Linuxï¼ˆARMï¼‰çš„èµ·æºï¼Œæœ‰ä¸€å¥â€œThis whole ARM thing is a f*cking pain in the assâ€å…¸æ•…ã€‚æœ‰å…´è¶£è‡ªæŸ¥ã€‚</p>
</blockquote>
<p>æœ¬è´¨ä¸Šï¼Œè®¾å¤‡æ ‘æ¨¡å‹å…¶å®å’Œä¸Šé¢çš„æ€»çº¿æ¨¡å‹å¾ˆåƒï¼Œå¦‚ä¸‹å›¾ï¼Œè®¾å¤‡æ ‘çš„æ ¹èŠ‚ç‚¹å°±æ˜¯ç³»ç»Ÿæ€»çº¿ã€‚</p>
<p><img src="http://imgjry.fangyikuan.xyz/20230222/20230222-Linux-9.png" alt="DeviceTree"></p>
<p>ä¸‰ä¸ªå¸¸è§è¯ï¼š</p>
<ul>
<li>DTSï¼šè®¾å¤‡æ ‘çš„æºæ–‡ä»¶<code>.dts</code>ï¼Œç±»ä¼¼JSONæ ¼å¼ï¼Œç»™äººè¯»å†™çš„</li>
<li>DTSIï¼šè®¾å¤‡æ ‘å¤´æ–‡ä»¶<code>.dtsi</code>ï¼Œæ”¾é€šç”¨é…ç½®ï¼Œæ¯”å¦‚ARM Cortex-A7çš„é…ç½®å¯¹äºä¸€æ‰¹SoCéƒ½èƒ½ç”¨</li>
<li>DTCï¼šç¼–è¯‘å™¨ï¼ŒæŠŠ<code>.dts</code>æ–‡ä»¶ç¼–è¯‘æˆ<code>.dtb</code>æ–‡ä»¶</li>
<li>DTBï¼šäºŒè¿›åˆ¶è®¾å¤‡æ ‘æ–‡ä»¶<code>.dtb</code>ï¼Œç»™Linuxè¯»çš„</li>
</ul>
<h3 id="è®¾å¤‡æ ‘æºæ–‡ä»¶å†™æ³•"><a href="#è®¾å¤‡æ ‘æºæ–‡ä»¶å†™æ³•" class="headerlink" title="è®¾å¤‡æ ‘æºæ–‡ä»¶å†™æ³•"></a>è®¾å¤‡æ ‘æºæ–‡ä»¶å†™æ³•</h3><p>å…ˆçœ‹åå­¦ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common_part_board_header.dtsi&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common_part_header_2.h&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">/ &#123;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">  #address-cells = &lt;1&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">  #size-cells = &lt;1&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">  aliases &#123;</span></span></span><br><span class="line"><span class="string"><span class="meta">    serial0 = &amp;uart4;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &#125;;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">  cpus &#123;</span></span></span><br><span class="line"><span class="string"><span class="meta">    #address-cells = &lt;1&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">    #size-cells = &lt;0&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">    cpu0: cpu@0 &#123;</span></span></span><br><span class="line"><span class="string"><span class="meta">      compatible = &quot;</span>arm,cortex-a7<span class="string">&quot;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      device_type = &quot;</span>cp<span class="string">u&quot;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      reg = &lt;0&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      clocks = &lt;&amp;scmi0_clk CK_SCMI0_MPU&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      clock-names = &quot;</span>cp<span class="string">u&quot;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      operating-points-v2 = &lt;&amp;cpu0_opp_table&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      nvmem-cells = &lt;&amp;part_number_otp&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      nvmem-cell-names = &quot;</span>part_number<span class="string">&quot;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      #cooling-cells = &lt;2&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &#125;;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &#125;;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">  soc &#123;</span></span></span><br><span class="line"><span class="string"><span class="meta">    compatible = &quot;</span>simple-bus<span class="string">&quot;;</span></span></span><br><span class="line"><span class="string"><span class="meta">    #address-cells = &lt;1&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">    #size-cells = &lt;1&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">    interrupt-parent = &lt;&amp;intc&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">    ranges;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">    sram: sram@10000000 &#123;</span></span></span><br><span class="line"><span class="string"><span class="meta">      compatible = &quot;</span>mmio-sram<span class="string">&quot;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      reg = &lt;0x10000000 0x60000&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      #address-cells = &lt;1&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      #size-cells = &lt;1&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">      ranges = &lt;0 0x10000000 0x60000&gt;;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &#125;;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &#125;;</span></span></span><br><span class="line"><span class="string"><span class="meta">&#125;;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>å¯åŒ…å«<code>.dtsi</code>å¤´æ–‡ä»¶å¼•å…¥é€šç”¨çš„å±æ€§ï¼Œä¹Ÿå¯ä»¥åŒ…å«æ ‡å‡†Cå½¢å¼çš„å¤´æ–‡ä»¶<code>.h</code></li>
<li>æ¯ä¸ªdtsæ–‡ä»¶åªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹<code>/</code>ï¼ŒåŒ…å«äº†å…¶ä»–æ–‡ä»¶ä¸­çš„è®¾å¤‡æ ‘ä¹‹åè‡ªåŠ¨åˆå¹¶æ ¹èŠ‚ç‚¹</li>
<li>æ¯ä¸ªè®¾å¤‡å¿…æ˜¯å­èŠ‚ç‚¹</li>
<li>èŠ‚ç‚¹å‘½åæ–¹å¼ï¼š<code>node-name@address</code>ï¼ŒååŠéƒ¨åˆ†åœ°å€ï¼ˆ@addressï¼‰è®°å½•è®¾å¤‡åœ°å€æˆ–å¯„å­˜å™¨é¦–åœ°å€ï¼Œä¸ç”¨å¯ä»¥ä¸è¦</li>
<li>èŠ‚ç‚¹å¯èµ·æ ‡ç­¾ï¼ˆlabelï¼‰ï¼š<code>label: node-name@unit-address</code></li>
<li>æ ‡ç­¾å¯åœ¨å…¶ä»–åœ°æ–¹å¿«é€Ÿç´¢å¼•èŠ‚ç‚¹ï¼š<code>@label</code></li>
<li>æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥æœ‰ï¼šå­èŠ‚ç‚¹ï¼Œå±æ€§ï¼ˆé”®å€¼å¯¹ï¼Œå¦‚<code>reg=&lt;0&gt;;</code>ï¼‰</li>
<li>å±æ€§ä¸­çš„æ•°å€¼å¯ä»¥æ˜¯ï¼š<ul>
<li>å­—ç¬¦ä¸²<code>compatible = &quot;arm,cortex-a7&quot;;</code></li>
<li>å­—ç¬¦ä¸²åˆ—è¡¨<code>compatible = &quot;arm,cortex-a7&quot;,&quot;arm,cortex-a53&quot;;</code></li>
<li>æ— ç¬¦å·æ•´æ•°<code>reg = &lt;0 0x123456 100&gt;;</code></li>
</ul>
</li>
<li>Linuxå†…æ ¸ä½¿ç”¨çš„æ ‡å‡†å±æ€§<ul>
<li>compatibleï¼Œå…¼å®¹æ€§å±æ€§ï¼šç”¨æ¥åŒ¹é…é©±åŠ¨ç¨‹åº</li>
<li>modelï¼Œæ¨¡å—ä¿¡æ¯ï¼šæè¿°æ¨¡å—åå­—</li>
<li>statusï¼Œè®¾å¤‡çŠ¶æ€ï¼Œå–å€¼ï¼ˆå­—ç¬¦ä¸²ï¼‰ä¸ºï¼š<ul>
<li>â€œokayâ€ï¼šå¯ç”¨</li>
<li>â€œdisabledâ€ï¼šä¸å¯ç”¨ï¼Œä½†æœªæ¥å¯ç”¨ã€‚å¸¸è§äºçƒ­æ‹”æ’æ¥å£</li>
<li>â€œfailâ€ï¼šå‡ºé”™</li>
<li>â€œfail-sssâ€ï¼šsssæ˜¯å‡ºé”™å†…å®¹</li>
</ul>
</li>
<li>#address-cellsï¼Œregå±æ€§ä¸­åœ°å€çš„å­—é•¿ï¼Œå­—ä¸º32ä½</li>
<li>#size-cellsï¼Œregå±æ€§ä¸­é•¿åº¦ä¿¡æ¯çš„å­—é•¿</li>
<li>regï¼Œæè¿°è®¾å¤‡åœ°å€ç©ºé—´ï¼Œå†™æ³•ï¼š<code>reg = &lt;address1 length1 address2 length2 address3 length3â€¦â€¦&gt;</code></li>
<li>rangesï¼Œåœ°å€æ˜ å°„&#x2F;è½¬æ¢è¡¨ï¼Œå†™æ³•ï¼š<code>ranges = &lt;child-bus-address parent-bus-address length&gt;;</code></li>
</ul>
</li>
</ul>
<h3 id="è¿½åŠ -x2F-ä¿®æ”¹èŠ‚ç‚¹å†…å®¹"><a href="#è¿½åŠ -x2F-ä¿®æ”¹èŠ‚ç‚¹å†…å®¹" class="headerlink" title="è¿½åŠ &#x2F;ä¿®æ”¹èŠ‚ç‚¹å†…å®¹"></a>è¿½åŠ &#x2F;ä¿®æ”¹èŠ‚ç‚¹å†…å®¹</h3><p>ä½¿ç”¨<code>#include</code>åŒ…å«äº†é€šç”¨<code>.dtsi</code>å¤´æ–‡ä»¶çš„å†…å®¹åï¼Œå¦‚æœè¦å¯¹å…¶ä¸­çš„æŸä¸ªèŠ‚ç‚¹å†…å®¹è¿›è¡Œä¿®æ”¹ï¼Œæˆ–è€…å¢åŠ ï¼Œåº”è¯¥ä½¿ç”¨<strong>å¼•ç”¨</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c1 &#123;</span><br><span class="line"><span class="comment">/* è¦è¿½åŠ æˆ–ä¿®æ”¹çš„å†…å®¹ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="è®¾å¤‡æ ‘å¦‚ä½•ä½œç”¨äºé©±åŠ¨"><a href="#è®¾å¤‡æ ‘å¦‚ä½•ä½œç”¨äºé©±åŠ¨" class="headerlink" title="è®¾å¤‡æ ‘å¦‚ä½•ä½œç”¨äºé©±åŠ¨"></a>è®¾å¤‡æ ‘å¦‚ä½•ä½œç”¨äºé©±åŠ¨</h3><p>è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶<code>.dtb</code>è¢«Linuxå†…æ ¸è§£è¯»åï¼Œç›¸å…³å‚æ•°å°±å¯ä»¥è¢«é©±åŠ¨ç¨‹åºè¯»å–äº†ã€‚é©±åŠ¨ç¨‹åºå®ç°ä¸­ï¼ŒåŸºç¡€çš„ç¡¬ä»¶äº¤äº’æ“ä½œéƒ½ä¸ç”¨æ”¹åŠ¨ï¼Œä¸»è¦æ˜¯æ¨¡å—åˆå§‹åŒ–å‡½æ•°ä¸­ï¼ŒåŠ å…¥è¯»å–è®¾å¤‡æ ‘ã€åŒ¹é…è®¾å¤‡ã€è·å–å‚æ•°çš„åŠŸèƒ½ã€‚å…³é”®æ¥å£ï¼š</p>
<ul>
<li>è·å–èŠ‚ç‚¹ï¼š<code>of_find_node_by_path</code></li>
<li>è¯»å±æ€§ï¼š<code>of_find_property</code></li>
<li>è¯»å­—ç¬¦ï¼š<code>of_property_read_string</code></li>
<li>è¯»æ•°ç»„ï¼š<code>of_property_read_u32_array</code></li>
<li>å†…å­˜æ˜ å°„ï¼š<code>of_iomap</code></li>
</ul>
<p>å…·ä½“è§ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  u32 val = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> ret;</span><br><span class="line">  u32 regdata[<span class="number">12</span>];</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *str;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">proper</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è·å–è®¾å¤‡æ ‘ä¸­çš„å±æ€§æ•°æ® */</span></span><br><span class="line">  <span class="comment">/* 1ã€è·å–è®¾å¤‡èŠ‚ç‚¹ï¼šstm32mp1_led */</span></span><br><span class="line">  dtsled.nd = of_find_node_by_path(<span class="string">&quot;/stm32mp1_led&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(dtsled.nd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    printk(<span class="string">&quot;stm32mp1_led node nost find!\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;stm32mp1_lcd node find!\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 2ã€è·å– compatible å±æ€§å†…å®¹ */</span></span><br><span class="line">  proper = of_find_property(dtsled.nd, <span class="string">&quot;compatible&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span>(proper == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    printk(<span class="string">&quot;compatible property find failed\r\n&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;compatible = %s\r\n&quot;</span>, (<span class="type">char</span>*)proper-&gt;value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 3ã€è·å– status å±æ€§å†…å®¹ */</span></span><br><span class="line">  ret = of_property_read_string(dtsled.nd, <span class="string">&quot;status&quot;</span>, &amp;str);</span><br><span class="line">  <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    printk(<span class="string">&quot;status read failed!\r\n&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;status = %s\r\n&quot;</span>,str);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 4ã€è·å– reg å±æ€§å†…å®¹ */</span></span><br><span class="line">  ret = of_property_read_u32_array(dtsled.nd, <span class="string">&quot;reg&quot;</span>, regdata, <span class="number">12</span>);</span><br><span class="line">  <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    printk(<span class="string">&quot;reg property read failed!\r\n&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    printk(<span class="string">&quot;reg data:\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i++)</span><br><span class="line">    printk(<span class="string">&quot;%#X &quot;</span>, regdata[i]);</span><br><span class="line">    printk(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* åˆå§‹åŒ– LED */</span></span><br><span class="line">  <span class="comment">// ç•¥</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* æ³¨å†Œå­—ç¬¦è®¾å¤‡é©±åŠ¨ */</span></span><br><span class="line">  <span class="comment">/* 1ã€åˆ›å»ºè®¾å¤‡å· */</span></span><br><span class="line">  <span class="keyword">if</span> (dtsled.major) &#123; <span class="comment">/* å®šä¹‰äº†è®¾å¤‡å· */</span></span><br><span class="line">    dtsled.devid = MKDEV(dtsled.major, <span class="number">0</span>);</span><br><span class="line">    ret = register_chrdev_region(dtsled.devid, DTSLED_CNT,DTSLED_NAME);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      pr_err(<span class="string">&quot;cannot register %s char driver [ret=%d]\n&quot;</span>,DTSLED_NAME, DTSLED_CNT);</span><br><span class="line">      <span class="keyword">goto</span> fail_map;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">/* æ²¡æœ‰å®šä¹‰è®¾å¤‡å· */</span></span><br><span class="line">    ret = alloc_chrdev_region(&amp;dtsled.devid, <span class="number">0</span>, DTSLED_CNT,DTSLED_NAME); <span class="comment">/* ç”³è¯·è®¾å¤‡å· */</span></span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      pr_err(<span class="string">&quot;%s Couldn&#x27;t alloc_chrdev_region, ret=%d\r\n&quot;</span>,DTSLED_NAME, ret);</span><br><span class="line">      <span class="keyword">goto</span> fail_map;</span><br><span class="line">    &#125;</span><br><span class="line">    dtsled.major = MAJOR(dtsled.devid); <span class="comment">/* è·å–åˆ†é…å·çš„ä¸»è®¾å¤‡å· */</span></span><br><span class="line">    dtsled.minor = MINOR(dtsled.devid); <span class="comment">/* è·å–åˆ†é…å·çš„æ¬¡è®¾å¤‡å· */</span></span><br><span class="line">  &#125;</span><br><span class="line">  printk(<span class="string">&quot;dtsled major=%d,minor=%d\r\n&quot;</span>,dtsled.major,</span><br><span class="line">  dtsled.minor); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 2ã€åˆå§‹åŒ– cdev */</span></span><br><span class="line">  dtsled.cdev.owner = THIS_MODULE;</span><br><span class="line">  cdev_init(&amp;dtsled.cdev, &amp;dtsled_fops);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 3ã€æ·»åŠ ä¸€ä¸ª cdev */</span></span><br><span class="line">  ret = cdev_add(&amp;dtsled.cdev, dtsled.devid, DTSLED_CNT);</span><br><span class="line">  <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">goto</span> del_unregister;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 4ã€åˆ›å»ºç±» */</span></span><br><span class="line">  dtsled.class = class_create(THIS_MODULE, DTSLED_NAME);</span><br><span class="line">  <span class="keyword">if</span> (IS_ERR(dtsled.class)) &#123;</span><br><span class="line">  <span class="keyword">goto</span> del_cdev;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 5ã€åˆ›å»ºè®¾å¤‡ */</span></span><br><span class="line">  dtsled.device = device_create(dtsled.class, <span class="literal">NULL</span>, dtsled.devid, <span class="literal">NULL</span>, DTSLED_NAME);</span><br><span class="line">  <span class="keyword">if</span> (IS_ERR(dtsled.device)) &#123;</span><br><span class="line">    <span class="keyword">goto</span> destroy_class;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  destroy_class:</span><br><span class="line">  class_destroy(dtsled.class);</span><br><span class="line">  del_cdev:</span><br><span class="line">  cdev_del(&amp;dtsled.cdev);</span><br><span class="line">  del_unregister:</span><br><span class="line">  unregister_chrdev_region(dtsled.devid, DTSLED_CNT);</span><br><span class="line">  fail_map:</span><br><span class="line">  led_unmap();</span><br><span class="line">  <span class="keyword">return</span> -EIO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">led_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  led_unmap();</span><br><span class="line"></span><br><span class="line">  cdev_del(&amp;dtsled.cdev);</span><br><span class="line"></span><br><span class="line">  unregister_chrdev_region(dtsled.devid, DTSLED_CNT);</span><br><span class="line">  device_destroy(dtsled.class, dtsled.devid);</span><br><span class="line">  class_destroy(dtsled.class);</span><br><span class="line">&#125;</span><br><span class="line">module_init(led_init);</span><br><span class="line">module_exit(led_exit);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>Copyrightï¼š </strong>
          
          Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        åˆ†äº«
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://www.singularity-blog.top/2023/02/22/LinuxDriver/" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/" rel="tag">é©±åŠ¨ç¨‹åº</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
    
      <a href="/2022/08/28/ElectricCompass-FromZeroToInf/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
        <div class="article-nav-title">ç”µå­ç½—ç›˜çš„ç†è®ºåˆ†æä¸å®é™…åº”ç”¨ï¼ˆAK09915ï¼‰</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2023
        <i class="ri-heart-fill heart_icon"></i> RY.J
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>Visitors:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>Views:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzzç»Ÿè®¡ -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/S-logo-side.svg" alt="Singularity-blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">ä¸»é¡µ</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">å½’æ¡£</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">åˆ†ç±»</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">æ ‡ç­¾</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/aboutMe">å…³äºæˆ‘</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>è¯·æˆ‘å–æ¯å’–å•¡å§~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">æ”¯ä»˜å®</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.png">
      <span class="reward-type">å¾®ä¿¡</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // sliderå±•å¼€çŠ¶æ€
                // todo: è¿™æ ·ä¸å¥½ï¼Œåé¢æ”¹æˆçŠ¶æ€
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // è·å¾—åŸå›¾å°ºå¯¸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.staticfile.org/mathjax/2.7.7/MathJax.js"></script>
<script src="https://cdn.staticfile.org/mathjax/2.7.7/config/TeX-AMS-MML_HTMLorMML-full.js"></script>
<script>
  var ayerConfig = {
    mathjax: true,
  };
</script>

<!-- Katex -->
 
    
 
<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="86"
        src="//music.163.com/outchain/player?type=2&id=1357887419&auto=0&height=66"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
</body>

</html>